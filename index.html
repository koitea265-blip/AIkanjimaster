<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ＡＩかん字マスター</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=block" rel="stylesheet">
  <style>
    :root {
      --bg-color: #fffbeb;
      --ink-black: #1e293b;
      --ink-blue: #0ea5e9;
      --grid-line: #bae6fd;
      --btn-shadow: #0f172a20;
    }
    body {
      font-family: 'Klee One', "UD デジタル 教科書体 N-R", "UD Digi Kyokasho N-R", "HG正楷書体-PRO", "HGKyokashotai", serif; 
      font-weight: 600;
      background-color: var(--bg-color);
      color: #334155;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      touch-action: none;
      opacity: 0; 
      transition: opacity 0.5s ease-in-out;
      -webkit-user-select: none; /* テキスト選択禁止 (Safari) */
      user-select: none; /* テキスト選択禁止 (標準) */
      -webkit-touch-callout: none; /* iOSの長押しメニュー禁止 */
    }
    
    /* 入力欄だけは文字が打てるように選択可能にする */
    input {
      -webkit-user-select: auto;
      user-select: auto;
    }
    
    .kyokasho { font-family: inherit; }
    
    .kanji-grid {
      position: relative;
      background-color: #ffffff;
      border: 4px solid #cbd5e1;
      border-radius: 1.5rem;
      box-shadow: 0 8px 20px var(--btn-shadow);
      overflow: hidden;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }
    .grid-line-v {
      position: absolute; top: 0; left: 50%; width: 0; height: 100%;
      border-left: 2px dashed var(--grid-line);
      pointer-events: none; z-index: 1;
    }
    .grid-line-h {
      position: absolute; top: 50%; left: 0; width: 100%; height: 0;
      border-top: 2px dashed var(--grid-line);
      pointer-events: none; z-index: 1;
    }
    .reading-card {
      border-radius: 0.75rem;
      border: 2px solid var(--grid-line);
      background: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 4.5rem;
      box-shadow: 0 4px 10px var(--btn-shadow);
      flex-shrink: 0;
    }
    @media (min-width: 768px) {
      .reading-card {
        border-radius: 1.25rem;
        border-width: 3px;
        width: 6.8rem;
      }
    }
    .reading-columns {
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      gap: 0.1rem;
      flex: 1;
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
    }
    @media (min-width: 768px) {
      .reading-columns {
        gap: 0.25rem;
      }
    }
    .vertical-text {
      writing-mode: vertical-rl;
      font-weight: 800;
      line-height: 1.1;
      font-size: 0.9rem;
      white-space: nowrap;
      letter-spacing: 0.05em;
    }
    @media (min-width: 768px) {
      .vertical-text {
        line-height: 1.4;
        font-size: 1.25rem;
        letter-spacing: 0.1em;
      }
    }
    .btn-action {
      transition: all 0.1s ease;
      border-bottom-width: 4px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (min-width: 768px) {
      .btn-action {
        border-bottom-width: 6px;
        min-height: 56px;
      }
    }
    .btn-action:active { transform: translateY(4px); border-bottom-width: 2px; }
    .grade-btn {
      width: 24px; height: 24px; border-radius: 50%; font-size: 0.75rem; font-weight: 900;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      border-bottom: 2px solid #00000020;
    }
    @media (min-width: 768px) {
      .grade-btn {
        width: 32px; height: 32px; font-size: 0.9rem; border-bottom-width: 3px;
      }
    }
    .grade-btn.active {
      background-color: #6366f1; color: white; transform: scale(1.1); border-bottom: 2px solid #4338ca;
    }
    @media (min-width: 768px) {
      .grade-btn.active {
        border-bottom-width: 3px;
      }
    }
    #speedSlider {
      -webkit-appearance: none; width: 100%; height: 16px; border-radius: 8px;
      background: #e2e8f0; outline: none; transition: background 0.1s;
    }
    #speedSlider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 34px; height: 34px; background: #ffffff;
      border-radius: 50%; cursor: pointer; border: 4px solid #38bdf8; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .locked { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; transition: all 0.3s; }
    .scroll-hide::-webkit-scrollbar { display: none; }
    .info-stroke-path { stroke: #334155; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .bg-stroke-path { stroke: #f1f5f9; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .stroke-path { stroke: #000000; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    #confettiCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
  </style>
</head>
<body id="appBody" class="p-1 md:p-2 box-border">
  <canvas id="confettiCanvas"></canvas>

  <div id="excellentPopup" class="fixed inset-0 pointer-events-none z-[200] flex items-center justify-center opacity-0 scale-50 transition-all duration-500">
    <div class="bg-white/95 backdrop-blur-sm px-8 py-6 rounded-3xl shadow-2xl border-4 border-emerald-400 transform -rotate-2">
      <span class="text-4xl md:text-7xl font-black text-emerald-500 drop-shadow-sm tracking-widest leading-none">💮よくできました</span>
    </div>
  </div>

  <header class="h-12 md:h-16 shrink-0 flex items-center justify-between bg-white px-2 md:px-4 rounded-xl shadow-sm border-b-2 md:border-b-4 border-slate-200 mb-1 md:mb-2 z-10 relative overflow-x-auto scroll-hide">
    <div class="flex-1 flex items-center justify-center gap-2 md:gap-8 min-w-max">
      <h1 class="text-lg md:text-3xl font-black text-indigo-600 tracking-tighter shrink-0 drop-shadow-sm">ＡＩかん字マスター</h1>
      
      <div class="flex items-center gap-2 md:gap-3">
        <div id="gradeButtons" class="flex gap-1 md:gap-1.5 bg-slate-100 p-1 md:p-1.5 rounded-full shadow-inner">
          <button onclick="changeGrade(1)" id="gb1" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">1</button>
          <button onclick="changeGrade(2)" id="gb2" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">2</button>
          <button onclick="changeGrade(3)" id="gb3" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">3</button>
          <button onclick="changeGrade(4)" id="gb4" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">4</button>
          <button onclick="changeGrade(5)" id="gb5" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">5</button>
          <button onclick="changeGrade(6)" id="gb6" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">6</button>
        </div>

        <div class="flex items-center gap-1 bg-slate-100 p-1 md:p-1.5 rounded-full border-2 border-transparent focus-within:border-indigo-300 transition-all shadow-inner">
          <input type="text" id="searchInput" maxlength="1" placeholder="さがす" class="w-8 md:w-14 text-sm md:text-base bg-transparent text-center font-black text-indigo-600 focus:outline-none placeholder:text-slate-300">
          <button id="searchBtn" class="bg-indigo-500 text-white w-6 h-6 md:w-7 md:h-7 rounded-full flex items-center justify-center hover:bg-indigo-600 active:scale-90 transition-all shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 md:h-4 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="bg-amber-100 text-amber-600 px-2 py-1 md:px-3 md:py-1.5 rounded-full font-black text-xs md:text-sm shadow-inner shrink-0 ml-1 md:ml-3">
      🏆 <span id="masterTotalCount">0</span>
    </div>
  </header>

  <main class="flex-1 flex flex-col md:flex-row gap-1 md:gap-3 min-h-0 overflow-hidden z-10 relative">
    <section class="flex-1 bg-white rounded-2xl md:rounded-3xl shadow-lg border-2 md:border-4 border-sky-100 flex flex-col p-1.5 md:p-3 overflow-hidden relative">
      <div id="infoFrame" class="absolute inset-0 flex flex-col p-1.5 md:p-3 transition-opacity duration-300">
        <div class="text-center shrink-0 mb-0.5 md:mb-2 mt-0" id="currentGradeLabelContainer">
          <div id="currentGradeLabel" class="text-indigo-500 font-black text-sm md:text-xl tracking-widest leading-none">１ねんせいでならうかん字</div>
        </div>

        <div id="infoLabel" class="flex justify-end items-center mb-0.5 md:mb-1 shrink-0">
          <div class="bg-indigo-600 px-3 py-0.5 md:px-5 md:py-2 rounded-xl md:rounded-2xl text-white shadow-md flex items-baseline gap-0.5 md:gap-1">
            <span id="strokeCountText" class="text-lg md:text-3xl font-black">-</span>
            <span class="text-xs md:text-sm font-bold opacity-90">画</span>
          </div>
        </div>
        
        <div class="flex-1 flex items-center justify-center min-h-0 gap-1 md:gap-3 w-full py-0.5 md:py-1 mx-auto max-w-[800px]">
          <div id="kunCard" class="reading-card border-sky-100 text-sky-700 h-full max-h-[420px]">
            <span class="text-[10px] md:text-xs font-black my-1 md:my-2 bg-sky-50 text-sky-600 px-1.5 py-0.5 md:px-3 md:py-1 rounded-full border border-sky-200 shrink-0">くんよみ</span>
            <div id="kunReadings" class="reading-columns scroll-hide w-full flex-1"></div>
          </div>
          
          <div class="h-full aspect-square max-h-[420px] flex-shrink-0">
            <div class="kanji-grid border-slate-100">
              <div class="grid-line-v"></div><div class="grid-line-h"></div>
              <svg id="infoKanjiSvg" viewBox="0 0 109 109" class="w-full h-full absolute inset-0 z-10"></svg>
            </div>
          </div>
          
          <div id="onCard" class="reading-card border-rose-100 text-rose-700 h-full max-h-[420px]">
            <span class="text-[10px] md:text-xs font-black my-1 md:my-2 bg-rose-50 text-rose-600 px-1.5 py-0.5 md:px-3 md:py-1 rounded-full border border-rose-200 shrink-0">おんよみ</span>
            <div id="onReadings" class="reading-columns scroll-hide w-full flex-1"></div>
          </div>
        </div>

        <div id="practiceControls" class="mt-1 md:mt-2 shrink-0 flex flex-col gap-1">
          <button id="submitBtn" class="bg-sky-400 text-white py-1.5 md:py-3 rounded-lg md:rounded-xl text-sm md:text-xl font-black shadow-lg border-b-4 md:border-b-6 border-sky-600 btn-action hover:bg-sky-500">
            つぎの かん字 ➡
          </button>
          <button id="showAnimeBtn" class="hidden bg-rose-500 text-white py-1.5 md:py-3 rounded-lg md:rounded-xl text-sm md:text-xl font-black shadow-lg border-b-4 md:border-b-6 border-rose-700 btn-action hover:bg-rose-600 animate-pulse">
            👀 かきじゅんをみる
          </button>
        </div>
      </div>

      <div id="animeFrame" class="hidden absolute inset-0 flex flex-col bg-sky-50 z-20 p-1.5 md:p-3">
        <div class="flex justify-between items-center mb-1 md:mb-2 shrink-0">
          <span class="text-[10px] md:text-xs font-bold text-sky-500 bg-white px-2 py-0.5 md:px-3 md:py-1 rounded-full shadow-sm">かきじゅん</span>
          <button id="closeAnimeBtn" class="bg-white text-slate-500 px-2 py-0.5 md:px-3 md:py-1 rounded-full font-bold text-[10px] md:text-xs border-2 border-slate-200 hover:text-rose-500 shadow-sm">✕ もどる</button>
        </div>
        <div class="flex-1 flex items-center justify-center min-h-0 w-full py-0.5 md:py-1">
          <div class="h-full aspect-square max-h-[420px]">
            <div class="kanji-grid border-sky-300 bg-white">
              <div class="grid-line-v"></div><div class="grid-line-h"></div>
              <svg id="animeSvg" viewBox="0 0 109 109" class="w-full h-full relative z-10">
                <g id="animeBgGroup"></g>
                <g id="strokeGroup"></g>
                <g id="numberGroup"></g>
              </svg>
            </div>
          </div>
        </div>
        <div class="mt-1 md:mt-2 bg-white p-1.5 md:p-3 rounded-lg md:rounded-xl shadow-sm border-2 border-sky-100 flex flex-col gap-1 md:gap-2 shrink-0">
          <div class="flex items-center gap-2 md:gap-4 w-full">
            <button id="playBtn" class="shrink-0 bg-sky-400 text-white w-8 h-8 md:w-12 md:h-12 rounded-full font-bold text-sm md:text-2xl flex items-center justify-center shadow-lg border-b-2 md:border-b-4 border-sky-600 btn-action">▶</button>
            <div class="flex-1 flex flex-col">
              <input type="range" id="speedSlider" min="1" max="10" value="5" class="w-full">
              <div class="flex justify-between text-[8px] md:text-[10px] text-sky-400 font-bold mt-1 px-1">
                <span>🐢 ゆっくり</span>
                <span>はやい 🐇</span>
              </div>
            </div>
          </div>
        </div>
        <button id="skipToNextBtn" class="mt-1 md:mt-2 bg-sky-400 text-white py-1.5 md:py-3 rounded-lg md:rounded-xl text-sm md:text-xl font-black shadow-lg border-b-4 md:border-b-6 border-sky-600 btn-action hover:bg-sky-500 shrink-0">
          つぎの かん字 ➡
        </button>
      </div>
    </section>

    <section id="writeSection" class="flex-1 bg-white rounded-2xl md:rounded-3xl shadow-lg border-2 md:border-4 border-orange-100 flex flex-col p-1.5 md:p-3 relative overflow-hidden">
      <div class="flex justify-between items-center mb-0.5 md:mb-1 shrink-0">
        <span class="text-[10px] md:text-xs font-bold text-orange-400 tracking-widest bg-orange-50 px-2 py-0.5 md:px-3 md:py-1 rounded-full">なぞりがき</span>
        <span id="testStatus" class="text-[10px] md:text-xs font-black text-slate-400 bg-slate-100 px-2 py-0.5 md:px-3 md:py-1 rounded-full shadow-inner">ロック中 🔒</span>
      </div>
      
      <div id="writeArea" class="flex-1 flex items-center justify-center min-h-0 relative locked w-full py-0.5 md:py-1">
        <div class="h-full aspect-square max-h-[420px]">
          <div id="writeGrid" class="kanji-grid border-orange-300">
            <div class="grid-line-v"></div><div class="grid-line-h"></div>
            <canvas id="guideCanvas" class="absolute inset-0 z-0 w-full h-full"></canvas>
            <canvas id="inkCanvas" class="absolute inset-0 z-10 w-full h-full"></canvas>
            <canvas id="writeCanvas" class="absolute inset-0 z-20 touch-none w-full h-full cursor-crosshair"></canvas>
          </div>
        </div>
      </div>
      
      <div class="mt-1 md:mt-2 flex gap-1 md:gap-2 shrink-0">
        <button id="clearBtn" class="flex-[1] bg-orange-50 text-orange-500 py-1 md:py-2 rounded-lg md:rounded-xl font-bold border-b-4 md:border-b-6 border-orange-200 btn-action locked flex flex-col leading-tight">
          <span class="text-xs md:text-base">やりなおし</span>
          <span class="text-[8px] md:text-[10px] opacity-70">最初から</span>
        </button>
        <button id="startPracticeBtn" class="flex-[2] bg-orange-400 text-white py-1.5 md:py-3 rounded-lg md:rounded-xl text-sm md:text-xl font-black shadow-lg border-b-4 md:border-b-6 border-orange-600 btn-action hover:bg-orange-500">
          れんしゅうする！
        </button>
      </div>
    </section>
  </main>

  <footer class="h-14 md:h-36 shrink-0 bg-white border-t-2 md:border-t-4 border-slate-100 flex flex-col px-2 md:px-3 py-0.5 md:py-1 z-10 relative">
    <div class="flex-1 flex items-center gap-1.5 md:gap-3 min-h-0">
      <div class="flex flex-col items-center shrink-0">
        <div class="bg-amber-100 text-amber-600 border-b-2 md:border-b-4 border-amber-300 rounded-lg md:rounded-xl px-1.5 py-0.5 md:px-3 md:py-1.5 font-black text-[10px] md:text-xs text-center shadow-sm leading-tight">
          マスター<span class="hidden md:inline">した<br>かん字</span>
        </div>
        <div id="gradeProgress" class="mt-0.5 md:mt-1 text-[9px] md:text-[10px] font-black text-slate-500 tracking-tighter">
          - / - 字
        </div>
      </div>
      <div id="masteredList" class="flex-1 flex flex-row md:flex-wrap gap-1 overflow-x-auto md:overflow-x-hidden overflow-y-hidden md:overflow-y-auto h-full content-center md:content-start items-center md:items-start py-0.5 md:py-1 scroll-hide"></div>
      <div class="shrink-0">
        <button id="resetAllBtn" class="text-[8px] md:text-[9px] text-slate-300 hover:text-rose-400 underline font-bold px-1">リセット</button>
      </div>
    </div>
    <div class="text-center text-[8px] md:text-[9px] text-slate-300 font-bold py-0 md:py-0.5 select-none pointer-events-none">
      ©2026　ＡＩかん字マスター　ＩＣＴ支援の杜
    </div>
  </footer>

  <script>
    // 学習指導要領 準拠 1,026文字データ
    // circleマーカーを出すための追加の読みデータを含みます
    const KANJI_DATA_RAW = `学年漢字音読み訓読み1年生一イチ、イッひと（つ）1年生右-みぎ1年生雨-あめ1年生円エン-1年生王オウ-1年生音-おと1年生下-した1年生火カひ1年生花-はな1年生貝-かい1年生学ガク、ガッ-1年生気キ-1年生九キュウ、クここの（つ）1年生休-やす（む）1年生玉-たま1年生金キンかね1年生空-そら1年生月ゲツ、ガツつき1年生犬-いぬ1年生見-み（る）1年生五ゴいつ（つ）1年生口-くち1年生校コウ-1年生左-ひだり1年生三サンみ、みっ（つ）1年生山-やま1年生子-こ1年生四シよ、よっ（つ）、よん1年生糸-いと1年生字ジ-1年生耳-みみ1年生七シチなな、なな（つ）1年生車-くるま1年生手-て1年生十ジュウとお1年生出-で（る）、だ（す）1年生女-おんな1年生小-ちい（さい）、こ、お1年生上-うえ、あ（がる）、あ（げる）1年生森-もり1年生人ジン、ニンひと1年生水スイみず1年生正-ただ（しい）1年生生-い（きる）、う（まれる）1年生青-あお、あお（い）1年生夕-ゆう1年生石-いし1年生赤-あか、あか（い）1年生千センち1年生川-かわ1年生先-さき1年生早-はや（い）1年生草-くさ1年生足-あし、た（す）1年生村-むら1年生大ダイ、タイおお（きい）1年生男-おとこ1年生竹-たけ1年生中チュウなか1年生虫-むし1年生町-まち1年生天テン-1年生田-た1年生土-つち1年生二ニふた（つ）1年生日ニチひ、か1年生入-はい（る）、い（れる）1年生年ネンとし1年生白-しろ、しろ（い）1年生八ハチやっ（つ）1年生百ヒャク-1年生文ブン-1年生木-き1年生本ホン-1年生名-な1年生目-め1年生立-た（つ）1年生力-ちから1年生林-はやし1年生六ロクむっ（つ）、むい2年生引インひ（く）2年生羽ウはね、は2年生雲ウンくも2年生園エンその2年生遠エンとお（い）2年生何カなに、なん2年生科カ-2年生夏カなつ2年生家カいえ2年生歌カうた、うた（う）2年生画ガ、カ-2年生回カイまわ（る）、まわ（す）2年生会カイあ（う）2年生海カイうみ2年生絵エ-2年生外ガイそと2年生角カクかど、つの2年生楽ガク、ラクたの（しい）、たの（しむ）2年生活カツ-2年生間カンあいだ、ま2年生丸ガンまる、まる（い）2年生岩ガンいわ2年生顔ガンかお2年生汽キ-2年生記キしる（す）2年生帰キかえ（る）2年生弓キュウゆみ2年生牛ギュウうし2年生魚ギョさかな、うお2年生京キョウみやこ2年生強キョウつよ（い）2年生教キョウおし（える）2年生近キンちか（い）2年生兄キョウあに2年生形ケイかたち2年生計ケイはか（る）2年生元ゲン、ガンもと2年生言ゲンい（う）2年生原ゲンはら2年生戸コと2年生古コふる（い）2年生午ゴ-2年生後ゴうし（ろ）、あと2年生語ゴかた（る）2年生工コウ、ク-2年生公コウおおやけ2年生広コウひろ（い）2年生交コウまじ（わる）2年生光コウひか（る）、ひかり2年生考コウかんが（える）2年生行コウ、ギョウい（く）、おこな（う）2年生高コウたか（い）2年生黄コウき2年生合ゴウ、ガッあ（う）、あ（わせる）2年生谷コクたに2年生国コクくに2年生黒コクくろ、くろ（い）2年生今コンいま2年生才サイ-2年生細サイほそ（い）、こま（かい）2年生作サク、サつく（る）2年生算サン-2年生止シと（まる）、と（める）2年生市シいち2年生矢シや2年生姉シあね2年生思シおも（う）2年生紙シかみ2年生寺ジてら2年生自ジみずか（ら）2年生時ジとき2年生室シツむろ2年生社シャやしろ2年生弱ジャクよわ（い）2年生首シュくび2年生秋シュウあき2年生週シュウ-2年生春シュンはる2年生書ショか（く）2年生少ショウすく（ない）、すこ（し）2年生場ジョウば2年生色ショクいろ2年生食ショクた（べる）、く（う）2年生心シンこころ2年生新シンあたら（しい）2年生親シンおや、した（しい）2年生図ズ、トはか（る）2年生数スウかず、かぞ（える）2年生西セイ、サイにし2年生声セイこえ2年生星セイほし2年生晴セイは（れる）2年生切セツき（る）、き（れる）2年生雪セツゆき2年生船センふね2年生線セン-2年生前ゼンまえ2年生組ソくみ、く（む）2年生走ソウはし（る）2年生多タおお（い）2年生太タイふと（い）、ふと（る）2年生体タイからだ2年生台ダイ、タイ-2年生地チ、ジ-2年生池チいけ2年生知チし（る）2年生茶チャ-2年生昼チュウひる2年生長チョウなが（い）2年生鳥チョウとり2年生朝チョウあさ2年生直チョクなお（す）2年生通ツウとお（る）、かよ（う）2年生弟テイ、ダイおとうと2年生店テンみせ2年生点テン-2年生電デン-2年生刀トウかたな2年生冬トウふゆ2年生当トウあ（たる）、あ（てる）2年生東トウひがし2年生答トウこた（える）、こた（え）2年生頭トウ、ズあたま2年生同ドウおな（じ）2年生道ドウみち2年生読ドクよ（む）2年生内ナイうち2年生南ナンみなみ2年生肉ニク-2年生馬バうま2年生売バイう（る）2年生買バイか（う）2年生麦バクむぎ2年生半ハンなか（ば）2年生番バン-2年生父フちち2年生風フウかぜ2年生分ブン、フンわ（ける）、わ（かる）2年生聞ブンき（く）、き（こえる）2年生米ベイ、マイこめ2年生歩ホある（く）2年生母ボはは2年生方ホウかた2年生北ホクきた2年生毎マイ-2年生妹マイいもうと2年生万マン、バン-2年生明メイあか（るい）、あ（ける）2年生鳴メイな（く）、な（る）2年生毛モウけ2年生門モンかど2年生夜ヤよる2年生野ヤの2年生友ユウとも2年生用ヨウもち（いる）2年生曜ヨウ-2年生来ライく（る）2年生里リさと2年生理リ-2年生話ワはな（す）、はな（し）2年生(追加)雨ウあま2年生(追加)音オン、インね2年生(追加)下カ、ゲさ（がる）、くだ（る）2年生(追加)花カ-2年生(追加)学-まな（ぶ）2年生(追加)休キュウやす（まる）、やす（める）2年生(追加)玉ギョク-2年生(追加)金コンかな2年生(追加)空クウあ（く）、あ（ける）、から2年生(追加)見ケンみ（える）、み（せる）2年生(追加)犬ケン-2年生(追加)口コウ、ク-2年生(追加)左サ-2年生(追加)山サン-2年生(追加)子シ、ス-2年生(追加)糸シ-2年生(追加)耳ジ-2年生(追加)車シャ-2年生(追加)手シュた2年生(追加)出シュツ、スイ-2年生(追加)女ジョ、ニョめ2年生(追加)小ショウ-2年生(追加)上ジョウ、ショウのぼ（る）、うわ、かみ2年生(追加)森シン-2年生(追加)正セイ、ショウただ（す）、まさ2年生(追加)生セイ、ショウは（える）、なま2年生(追加)青セイ、ショウ-2年生(追加)夕セキ-2年生(追加)石セキ、シャク-2年生(追加)赤セキ、シャク-2年生(追加)川セン-2年生(追加)先セン-2年生(追加)早ソウ-2年生(追加)草ソウ-2年生(追加)足ソクた（りる）2年生(追加)村ソン-2年生(追加)男ダン、ナン-2年生(追加)竹チク-2年生(追加)虫チュウ-2年生(追加)町チョウ-2年生(追加)天-あめ、あま2年生(追加)田デン-2年生(追加)土ド、ト-2年生(追加)白ハク、ビャクしら2年生(追加)文モンふみ2年生(追加)木ボク、モクこ2年生(追加)名ミョウ-2年生(追加)目モクま2年生(追加)立リツ、リュウた（てる）2年生(追加)力リョク、リキ-2年生(追加)林リン-3年生悪アクわる（い）3年生安アンやす（い）3年生暗アンくら（い）3年生医イ-3年生委イゆだ（ねる）3年生意イ-3年生育イクそだ（つ）、そだ（てる）、はぐく（む）3年生員イン-3年生院イン-3年生飲インの（む）3年生運ウンはこ（ぶ）3年生泳エイおよ（ぐ）3年生駅エキ-3年生央オウ-3年生横オウよこ3年生屋オクや3年生温オンあたた（かい）、あたた（まる）、あたた（める）3年生化カば（ける）3年生荷カに3年生界カイ-3年生開カイひら（く）、ひら（ける）、あ（く）、あ（ける）3年生階カイ-3年生寒カンさむ（い）3年生感カン-3年生漢カン-3年生館カンやかた3年生岸ガンきし3年生起キお（きる）、お（こる）、お（こす）3年生期キ、ゴ-3年生客キャク-3年生究キュウ-3年生急キュウいそ（ぐ）3年生級キュウ-3年生宮キュウ、グウみや3年生球キュウたま3年生去キョさ（る）3年生橋キョウはし3年生業ギョウ、ゴウわざ3年生曲キョクま（がる）、ま（げる）3年生局キョク-3年生銀ギン-3年生区ク-3年生苦クくる（しい）、くる（しむ）、くる（しめる）、にが（い）3年生具グ-3年生君クンきみ3年生係ケイかかり、かか（る）、かかわ（る）3年生軽ケイかる（い）3年生血ケツち3年生決ケツき（める）、き（まる）3年生研ケンと（ぐ）3年生県ケン-3年生庫コ-3年生湖コみずうみ3年生向コウむ（く）、む（ける）、む（かう）、む（こう）3年生幸コウさいわ（い）、さち、しあわ（せ）3年生港コウみなと3年生号ゴウ-3年生根コンね3年生祭サイまつ（る）、まつ（り）3年生皿-さら3年生仕シ、ジつか（える）3年生死シし（ぬ）3年生使シつか（う）3年生始シはじ（める）、はじ（まる）3年生指シゆび、さ（す）3年生歯シは3年生詩シ-3年生次ジつ（ぐ）、つぎ3年生事ジこと3年生持ジも（つ）3年生式シキ-3年生実ジツみ、みの（る）3年生写シャうつ（す）、うつ（る）3年生者シャもの3年生主シュぬし、おも3年生守シュ、スまも（る）、もり3年生取シュと（る）3年生酒シュさけ、さか3年生受ジュう（ける）、う（かる）3年生州シュウ、ス-3年生拾シュウひろ（う）3年生終シュウお（わる）、お（える）3年生習シュウなら（う）3年生集シュウあつ（まる）、あつ（める）3年生住ジュウす（む）3年生重ジュウ、チョウおも（い）、かさ（なる）、かさ（ねる）3年生宿シュクやど、やど（る）、やど（す）3年生所ショところ3年生暑ショあつ（い）3年生助ジョたす（ける）、たす（かる）、すけ3年生昭ショウ-3年生消ショウき（える）、け（す）3年生商ショウあきな（う）3年生章ショウ-3年生勝ショウか（つ）、まさ（る）3年生乗ジョウの（る）、の（せる）3年生植ショクう（える）、う（わる）3年生申シンもう（す）3年生身シンみ3年生神シン、ジンかみ、かん、こう3年生真シンま3年生深シンふか（い）、ふか（まる）、ふか（める）3年生進シンすす（む）、すす（める）3年生世セイ、セよ3年生整セイととの（える）、ととの（う）3年生昔セキむかし3年生全ゼンまった（く）、すべ（て）3年生相ソウあい3年生送ソウおく（る）3年生想ソウ-3年生息ソクいき3年生速ソクはや（い）、はや（める）、はや（まる）3年生族ゾク-3年生他タほか3年生打ダう（つ）3年生対タイ-3年生待タイま（つ）3年生代ダイか（わる）、か（える）、よ、しろ3年生第ダイ-3年生題ダイ-3年生炭タンすみ3年生短タンみじか（い）3年生談ダン-3年生着チャクき（る）、き（せる）、つ（く）、つ（ける）3年生注チュウそそ（ぐ）3年生柱チュウはしら3年生丁チョウ、テイ-3年生帳チョウ-3年生調チョウしら（べる）、ととの（う）、ととの（える）3年生追ツイお（う）3年生定テイ、ジョウさだ（める）、さだ（まる）3年生庭テイにわ3年生笛テキふえ3年生鉄テツ-3年生転テンころ（がる）、ころ（げる）、ころ（がす）、ころ（ぶ）3年生都ト、ツみやこ3年生度ド、トたび3年生投トウな（げる）3年生豆トウ、ズまめ3年生島トウしま3年生湯トウゆ3年生登トウ、トのぼ（る）3年生等トウひと（しい）、など3年生動ドウうご（く）、うご（かす）3年生童ドウわらべ3年生農ノウ-3年生波ハなみ3年生配ハイくば（る）3年生倍バイ-3年生箱-はこ3年生畑-はた、はたけ3年生発ハツ、ホツ-3年生反ハンそ（る）、そ（らす）3年生坂ハンさか3年生板ハン、バンいた3年生皮ヒかわ3年生悲ヒかな（しい）3年生美ビうつく（しい）3年生鼻ビはな3年生筆ヒツふで3年生氷ヒョウこおり、こお（る）3年生表ヒョウおもて、あらわ（す）、あらわ（れる）3年生秒ビョウ-3年生病ビョウや（む）、やまい3年生品ヒンしな3年生負フま（ける）、ま（かす）、お（う）3年生部ブ-3年生服フク-3年生福フク-3年生物ブツもの3年生平ヘイたい（ら）、ひら3年生返ヘンかえ（す）3年生勉ベン-3年生放ホウはな（す）、はな（つ）、はな（れる）、ほう（る）3年生味ミあじ、あじ（わう）3年生命メイいのち3年生面メンおも、おもて、つら3年生問モンと（う）、と（い）、とん3年生役ヤク-3年生薬ヤクくすり3年生由ユ、ユウよし3年生油ユあぶら3年生有ユウあ（る）3年生遊ユウあそ（ぶ）3年生予ヨ-3年生羊ヨウひつじ3年生洋ヨウ-3年生葉ヨウは3年生陽ヨウ-3年生様ヨウさま3年生落ラクお（ちる）、お（とす）3年生流リュウ、ルなが（れる）、なが（す）3年生旅リョたび3年生両リョウ-3年生緑リョクみどり3年生礼レイ-3年生列レツ-3年生練レンね（る）3年生路ロじ3年生和ワやわ（らぐ）、やわ（らげる）、なご（む）、なご（やか）3年生(追加)一イツ-3年生(追加)二ジ-3年生(追加)三-み3年生(追加)四-よん3年生(追加)六-むい3年生(追加)八-よう3年生(追加)九ク-3年生(追加)十ジッ-3年生(追加)日ジツ-3年生(追加)月ガツ-3年生(追加)金コン-3年生(追加)本-もと3年生(追加)上-のぼ（る）、のぼ（せる）、のぼ（す）3年生(追加)下ゲくだ（る）、くだ（す）、くだ（さる）、お（ろす）、お（りる）3年生(追加)円-まる（い）3年生(追加)会エ-3年生(追加)合ガッ-3年生(追加)交-まじ（る）、まざ（る）、まぜ（る）、か（う）、かわ（す）3年生(追加)分フン、ブわ（かつ）4年生愛アイ-4年生案アン-4年生以イ-4年生衣イころも4年生位イくらい4年生茨-いばら4年生印インしるし4年生英エイ-4年生栄エイさか（える）、は（える）4年生媛エン-4年生塩エンしお4年生岡-おか4年生億オク-4年生加カくわ（える）、くわ（わる）4年生果カは（たす）、は（てる）、はて4年生貨カ-4年生課カ-4年生芽ガめ4年生賀ガ-4年生改カイあらた（める）、あらた（まる）4年生械カイ-4年生害ガイ-4年生街ガイまち4年生各カクおのおの4年生覚カクおぼ（える）、さ（ます）、さ（める）4年生潟-かた4年生完カン-4年生官カン-4年生管カンくだ4年生関カンせき、かか（わる）4年生観カン-4年生願ガンねが（う）4年生岐キ-4年生希キ-4年生季キ-4年生旗キはた4年生器キうつわ4年生機キはた4年生議ギ-4年生求キュウもと（める）4年生泣キュウな（く）4年生給キュウ-4年生挙キョあ（げる）、あ（がる）4年生漁ギョ、リョウ-4年生共キョウとも4年生協キョウ-4年生鏡キョウかがみ4年生競キョウ、ケイきそ（う）、せ（る）4年生極キョク、ゴクきわ（める）、きわ（まる）、きわ（み）4年生熊-くま4年生訓クン-4年生軍グン-4年生郡グン-4年生群グンむ（れる）、むら（がる）、むら4年生径ケイ-4年生景ケイ-4年生芸ゲイ-4年生欠ケツか（ける）、か（く）4年生結ケツむす（ぶ）、ゆ（う）、ゆわ（える）4年生建ケンた（てる）、た（つ）4年生健ケンすこ（やか）4年生験ケン-4年生固コかた（める）、かた（まる）、かた（い）4年生功コウ-4年生好コウこの（む）、す（く）4年生香コウか、かお（り）、かお（る）4年生候コウそうろう4年生康コウ-4年生佐サ-4年生差サさ（す）4年生菜サイな4年生最サイもっと（も）4年生埼-さい4年生材ザイ-4年生崎-さき4年生昨サク-4年生札サツふだ4年生刷サツす（る）4年生察サツ-4年生参サンまい（る）4年生産サンう（む）、う（まれる）、うぶ4年生散サンち（る）、ち（らす）、ち（らかす）、ち（らかる）4年生残ザンのこ（る）、のこ（す）4年生氏シうじ4年生司シ-4年生試シこころ（みる）、ため（す）4年生児ジ-4年生治ジ、チおさ（める）、おさ（まる）、なお（る）、なお（す）4年生滋ジ-4年生辞ジや（める）4年生鹿-か、しか4年生失シツうしな（う）4年生借シャクか（りる）4年生種シュたね4年生周シュウまわ（り）4年生祝シュクいわ（う）4年生順ジュン-4年生初ショはじ（め）、はじ（めて）、はつ、うい、そ（める）4年生松ショウまつ4年生笑ショウわら（う）、え（む）4年生唱ショウとな（える）4年生焼ショウや（く）、や（ける）4年生照ショウて（る）、て（らす）、て（れる）4年生城ジョウしろ4年生縄ジョウなわ4年生臣シン、ジン-4年生信シン-4年生井-い4年生成セイ、ジョウな（る）、な（す）4年生省セイ、ショウかえり（みる）、はぶ（く）4年生清セイ、ショウきよ（い）、きよ（まる）、きよ（める）4年生静セイ、ジョウしず、しず（か）、しず（まる）、しず（める）4年生席セキ-4年生積セキつ（む）、つ（もる）4年生折セツお（る）、おり、お（れる）4年生節セツ、セチふし4年生説セツ、ゼイと（く）4年生浅センあさ（い）4年生戦センいくさ、たたか（う）4年生選センえら（ぶ）4年生然ゼン、ネン-4年生争ソウあらそ（う）4年生倉ソウくら4年生巣ソウす4年生束ソクたば4年生側ソクかわ4年生続ゾクつづ（く）、つづ（ける）4年生卒ソツ-4年生孫ソンまご4年生帯タイおび、おび（る）4年生隊タイ-4年生達タツ-4年生単タン-4年生置チお（く）4年生仲チュウなか4年生沖-おき4年生兆チョウきざ（す）、きざ（し）4年生低テイひく（い）、ひく（める）、ひく（まる）4年生底テイそこ4年生的テキまと4年生典テン-4年生伝デンつた（わる）、つた（える）、つた（う）4年生徒ト-4年生努ドつと（める）4年生灯トウひ4年生働ドウはたら（く）4年生特トク-4年生徳トク-4年生栃-とち4年生奈ナ-4年生梨-なし4年生熱ネツあつ（い）4年生念ネン-4年生敗ハイやぶ（れる）4年生梅バイうめ4年生博ハク、バク-4年生阪ハン-4年生飯ハンめし4年生飛ヒと（ぶ）、と（ばす）4年生必ヒツかなら（ず）4年生票ヒョウ-4年生標ヒョウ-4年生不フ、ブ-4年生夫フ、フウおっと4年生付フつ（ける）、つ（く）4年生府フ-4年生阜フ-4年生富フ、フウと（む）、とみ4年生副フク-4年生兵ヘイ、ヒョウ-4年生別ベツわか（れる）4年生辺ヘンあた（り）、べ4年生変ヘンか（わる）、か（える）4年生便ベン、ビンたよ（り）4年生包ホウつつ（む）4年生法ホウ、ハッ、ホッ-4年生望ボウ、モウのぞ（む）4年生牧ボクまき4年生末マツ、バツすえ4年生満マンみ（ちる）、み（たす）4年生未ミ-4年生民ミンたみ4年生無ム、ブな（い）4年生約ヤク-4年生勇ユウいさ（む）4年生要ヨウかなめ、い（る）4年生養ヨウやしな（う）4年生浴ヨクあ（びる）、あ（びせる）4年生利リき（く）4年生陸リク-4年生良リョウよ（い）4年生料リョウ-4年生量リョウはか（る）4年生輪リンわ4年生類ルイ-4年生令レイ-4年生冷レイつめ（たい）、ひ（える）、ひ（や）、ひ（やす）、ひ（やかす）、さ（める）、さ（ます）4年生例レイたと（える）4年生連レンつら（なる）、つら（ねる）、つ（れる）4年生老ロウお（いる）4年生労ロウ-4年生録ロク-4年生(追加)生ショウ-4年生(追加)女ニョ-4年生(追加)画カ-4年生(追加)作サ-4年生(追加)食ジキ-4年生(追加)通-とお（す）4年生(追加)化ケ-4年生(追加)去コ-4年生(追加)相ショウ-4年生(追加)物モツ-4年生(追加)役エキ-5年生圧アツ-5年生囲イかこ（む）、かこ（う）5年生移イうつ（る）、うつ（す）5年生因インよ（る）5年生永エイなが（い）5年生営エイいとな（む）5年生衛エイ-5年生易エキ、イやさ（しい）5年生益エキ、ヤク-5年生液エキ-5年生演エン-5年生応オウこた（える）5年生往オウ-5年生桜オウさくら5年生可カ-5年生仮カ、ケかり5年生価カあたい5年生河カかわ5年生過カす（ぎる）、す（ごす）、あやま（つ）、あやま（ち）5年生快カイこころよ（い）5年生解カイ、ゲと（く）、と（かす）、と（ける）5年生格カク、コウ-5年生確カクたし（か）、たし（かめる）5年生額ガクひたい5年生刊カン-5年生幹カンみき5年生慣カンな（れる）、な（らす）5年生眼ガン、ゲンまなこ5年生紀キ-5年生基キもと、もとい5年生寄キよ（る）、よ（せる）5年生規キ-5年生喜キよろこ（ぶ）5年生技ギわざ5年生義ギ-5年生逆ギャクさか、さか（らう）5年生久キュウ、クひさ（しい）5年生旧キュウ-5年生救キュウすく（う）5年生居キョい（る）5年生許キョゆる（す）5年生境キョウ、ケイさかい5年生均キン-5年生禁キン-5年生句ク-5年生型ケイかた5年生経ケイ、キョウへ（る）5年生潔ケツいさぎよ（い）5年生件ケン-5年生険ケンけわ（しい）5年生検ケン-5年生限ゲンかぎ（る）5年生現ゲンあらわ（れる）、あらわ（す）5年生減ゲンへ（る）、へ（らす）5年生故コゆえ5年生個コ-5年生護ゴ-5年生効コウき（く）5年生厚コウあつ（い）5年生耕コウたがや（す）5年生航コウ-5年生鉱コウ-5年生構コウかま（える）、かま（う）5年生興コウ、キョウおこ（る）、おこ（す）5年生講コウ-5年生告コクつ（げる）5年生混コンま（じる）、ま（ざる）、ま（ぜる）5年生査サ-5年生再サイ、サふたた（び）5年生災サイわざわ（い）5年生妻サイつま5年生採サイと（る）5年生際サイきわ5年生在ザイあ（る）5年生財ザイ、サイ-5年生罪ザイつみ5年生殺サツ、サイ、セツころ（す）5年生雑ザツ、ゾウ-5年生酸サン-5年生賛サン-5年生士シ-5年生支シささ（える）5年生史シ-5年生志シこころざ（す）、こころざし5年生枝シえだ5年生師シ-5年生資シ-5年生飼シか（う）5年生示ジ、シしめ（す）5年生似ジに（る）5年生識シキ-5年生質シツ、シチ、チ-5年生舎シャ-5年生謝シャあやま（る）5年生授ジュさず（ける）、さず（かる）5年生修シュウ、シュおさ（める）、おさ（まる）5年生述ジュツの（べる）5年生術ジュツ-5年生準ジュン-5年生序ジョ-5年生招ショウまね（く）5年生証ショウ-5年生象ショウ、ゾウ-5年生賞ショウ-5年生条ジョウ-5年生状ジョウ-5年生常ジョウつね、とこ5年生情ジョウ、セイなさ（け）5年生織ショク、シキお（る）5年生職ショク-5年生制セイ-5年生性セイ、ショウ-5年生政セイ、ショウまつりごと5年生勢セイいきお（い）5年生精セイ、ショウ-5年生製セイ-5年生税ゼイ-5年生責セキせ（める）5年生績セキ-5年生接セツつ（ぐ）5年生設セツもう（ける）5年生絶ゼツた（える）、た（やす）、た（つ）5年生祖ソ-5年生素ソ、ス-5年生総ソウ-5年生造ゾウつく（る）5年生像ゾウ-5年生増ゾウま（す）、ふ（える）、ふ（やす）5年生則ソク-5年生測ソクはか（る）5年生属ゾク-5年生率ソツ、リツひき（いる）5年生損ソンそこ（なう）、そこ（ねる）5年生貸タイか（す）5年生態タイ-5年生団ダン、トン-5年生断ダンた（つ）、ことわ（る）5年生築チクきず（く）5年生貯チョ-5年生張チョウは（る）5年生停テイ-5年生提テイ-5年生程テイほど5年生適テキ-5年生統トウす（べる）5年生堂ドウ-5年生銅ドウ-5年生導ドウみちび（く）5年生得トクえ（る）5年生毒ドク-5年生独ドクひとり5年生任ニンまか（せる）、まか（す）5年生燃ネンも（える）、も（やす）、も（す）5年生能ノウ-5年生破ハやぶ（る）、やぶ（れる）5年生犯ハンおか（す）5年生判ハン、バン-5年生版ハン-5年生比ヒくら（べる）5年生肥ヒこ（える）、こ（やす）、こ（やし）5年生非ヒ-5年生費ヒつい（やす）5年生備ビそな（える）、そな（わる）5年生評ヒョウ-5年生貧ヒン、ビンまず（しい）5年生布フぬの5年生婦フ-5年生武ブ、ム-5年生復フク-5年生複フク-5年生仏ブツほとけ5年生粉フンこな、こ5年生編ヘンあ（む）5年生弁ベン-5年生保ホたも（つ）5年生墓ボはか5年生報ホウむく（いる）5年生豊ホウゆた（か）5年生防ボウふせ（ぐ）5年生貿ボウ-5年生暴ボウ、バクあば（れる）、あば（く）5年生脈ミャク-5年生務ムつと（める）、つと（まる）5年生夢ムゆめ5年生迷メイまよ（う）5年生綿メンわた5年生輸ユ-5年生余ヨあま（る）、あま（す）5年生容ヨウ-5年生略リャク-5年生留リュウ、ルと（める）、と（まる）5年生領リョウ-5年生歴レキ-5年生(追加)絵カイ-5年生(追加)客カク-5年生(追加)礼ライ-5年生(追加)期ゴ-5年生(追加)治チ-5年生(追加)色シキ-5年生(追加)省セイ-5年生(追加)競ケイ-5年生(追加)説ゼイ-5年生(追加)夫フウ-5年生(追加)便ビン-6年生胃イ-6年生異イこと、こと（なる）6年生遺イ-6年生域イキ-6年生宇ウ-6年生映エイうつ（る）、うつ（す）、は（える）6年生延エンの（びる）、の（べる）、の（ばす）6年生沿エンそ（う）6年生恩オン-6年生我ガわれ、わ6年生灰カイはい6年生拡カク-6年生革カクかわ6年生閣カク-6年生割カツわ（る）、わり、わ（れる）6年生株-かぶ6年生干カンほ（す）、ひ（る）6年生巻カンま（く）、ま（き）6年生看カン-6年生簡カン-6年生危キあぶ（ない）、あや（うい）、あや（ぶむ）6年生机キつくえ6年生揮キ-6年生貴キたっと（い）、とうと（い）、たっと（ぶ）、とうと（ぶ）6年生疑ギうたが（う）6年生吸キュウす（う）6年生供キョウ、クそな（える）、とも6年生胸キョウむね、むな6年生郷キョウ、ゴウ-6年生勤キン、ゴンつと（める）、つと（まる）6年生筋キンすじ6年生系ケイ-6年生敬ケイうやま（う）6年生警ケイ-6年生劇ゲキ-6年生激ゲキはげ（しい）6年生穴ケツあな6年生券ケン-6年生絹ケンきぬ6年生権ケン、ゴン-6年生憲ケン-6年生源ゲンみなもと6年生厳ゲン、ゴンおごそ（か）、きび（しい）6年生己コ、キおのれ6年生呼コよ（ぶ）6年生誤ゴあやま（る）6年生后コウ-6年生孝コウ-6年生皇コウ、オウ-6年生紅コウ、クべに、くれない6年生降コウお（りる）、お（ろす）、ふ（る）6年生鋼コウはがね6年生刻コクきざ（む）6年生穀コク-6年生骨コツほね6年生困コンこま（る）6年生砂サ、シャすな6年生座ザすわ（る）6年生済サイす（む）、す（ます）6年生裁サイた（つ）、さば（く）6年生策サク-6年生冊サツ、サク-6年生蚕サンかいこ6年生至シいた（る）6年生私シわたくし、わたし6年生姿シすがた6年生視シ-6年生詞シ-6年生誌シ-6年生磁ジ-6年生射シャい（る）6年生捨シャす（てる）6年生尺シャク-6年生若ジャク、ニャクわか（い）、も（しくは）6年生樹ジュ-6年生収シュウおさ（める）、おさ（まる）6年生宗シュウ、ソウ-6年生就シュウ、ジュつ（く）、つ（ける）6年生衆シュウ、シュ-6年生従ジュウ、ショウ、ジュしたが（う）、したが（える）6年生縦ジュウたて6年生縮シュクちぢ（む）、ちぢ（まる）、ちぢ（める）、ちぢ（れる）、ちぢ（らす）6年生熟ジュクう（れる）6年生純ジュン-6年生処ショ-6年生署ショ-6年生諸ショ-6年生除ジョ、ジのぞ（く）6年生承ショウうけたまわ（る）6年生将ショウ-6年生傷ショウきず、いた（む）、いた（める）6年生障ショウさわ（る）6年生蒸ジョウむ（す）、む（れる）、む（らす）6年生針シンはり6年生仁ジン、ニ-6年生垂スイた（れる）、た（らす）6年生推スイお（す）6年生寸スン-6年生盛セイ、ジョウも（る）、さか（る）、さか（ん）6年生聖セイ-6年生誠セイまこと6年生舌ゼツした6年生宣セン-6年生専センもっぱ（ら）6年生泉センいずみ6年生洗センあら（う）6年生染センそ（める）、そ（まる）、し（みる）、し（み）6年生銭センぜに6年生善ゼンよ（い）6年生奏ソウかな（でる）6年生窓ソウまど6年生創ソウつく（る）6年生装ソウ、ショウよそお（う）6年生層ソウ-6年生操ソウみさお、あやつ（る）6年生蔵ゾウくら6年生臓ゾウ-6年生存ソン、ゾン-6年生尊ソンたっと（い）、とうと（い）、たっと（ぶ）、とうと（ぶ）6年生退タイしりぞ（く）、しりぞ（ける）6年生宅タク-6年生担タンにな（う）6年生探タンさが（す）、さぐ（る）6年生誕タン-6年生段ダン-6年生暖ダンあたた（か）、あたた（かい）、あたた（まる）、あたた（める）6年生値チね、あたい6年生宙チュウ-6年生忠チュウ-6年生著チョあらわ（す）、いちじる（しい）6年生庁チョウ-6年生頂チョウいただ（く）、いただき6年生腸チョウわた6年生潮チョウしお6年生賃チン-6年生痛ツウいた（い）、いた（む）、いた（める）6年生敵テキかたき6年生展テン-6年生討トウう（つ）6年生党トウ-6年生糖トウ-6年生届-とど（ける）、とど（く）6年生難ナンかた（い）、むずか（しい）6年生乳ニュウちち、ち6年生認ニンみと（める）6年生納ノウ、ナッ、ナ、ナン、トウおさ（める）、おさ（まる）6年生脳ノウ-6年生派ハ-6年生拝ハイおが（む）6年生背ハイせ、せい、そむ（く）、そむ（ける）6年生肺ハイ-6年生俳ハイ-6年生班ハン-6年生晩バン-6年生否ヒいな6年生批ヒ-6年生秘ヒひそ（か）6年生俵ヒョウたわら6年生腹フクはら6年生奮フンふる（う）6年生並ヘイなみ、なら（べる）、なら（ぶ）、なら（びに）6年生陛ヘイ-6年生閉ヘイと（じる）、と（ざす）、し（める）、し（まる）6年生片ヘンかた6年生補ホおぎな（う）6年生暮ボく（れる）、く（らす）6年生宝ホウたから6年生訪ホウおとず（れる）、たず（ねる）6年生亡ボウ、モウな（い）6年生忘ボウわす（れる）6年生棒ボウ-6年生枚マイ-6年生幕マク、バク-6年生密ミツ-6年生盟メイ-6年生模モ、ボ-6年生訳ヤクわけ6年生郵ユウ-6年生優ユウやさ（しい）、すぐ（れる）6年生預ヨあず（ける）、あず（かる）6年生幼ヨウおさな（い）6年生欲ヨクほっ（する）、ほ（しい）6年生翌ヨク-6年生乱ランみだ（れる）、みだ（す）6年生卵ランたまご6年生覧ラン-6年生裏リうら6年生律リツ、イチ-6年生臨リンのぞ（む）6年生朗ロウほが（らか）6年生論ロン-6年生(追加)後-おく（れる）6年生(追加)図ト-6年生(追加)家ケ-6年生(追加)黄オウ-6年生(追加)重チョウ-6年生(追加)相ショウ-6年生(追加)表-あらわ（す）、あらわ（れる）6年生(追加)期ゴ-6年生(追加)無ブ-6年生(追加)治チ-6年生(追加)易イ-6年生(追加)興キョウ-6年生(追加)率ソツ-`;

    let kanjiList = [];
    let kanjiStore = {}; 
    let appState = { 
      currentKanji: null, 
      mastered: [], 
      currentStroke: 0, 
      isPracticing: false, 
      animeIsRunning: false, 
      selectedGrade: 1,
      hasMistaken: false,
      reviewQueue: []
    };
    const kanjiPathsCache = {};
    let writeCanvas, inkCanvas, guideCanvas, ctxW, ctxInk, ctxGuide, audioCtx;

    let prefetchQueue = [];
    let isPrefetching = false;

    async function startPrefetching() {
      if (isPrefetching) return;
      isPrefetching = true;
      while (prefetchQueue.length > 0) {
        const char = prefetchQueue.shift();
        if (!kanjiPathsCache[char]) {
          await fetchKanjiVG(char);
          await new Promise(r => setTimeout(r, 20)); 
        }
      }
      isPrefetching = false;
    }

    function queuePrefetch(grade) {
      prefetchQueue = [];
      appState.reviewQueue.forEach(q => { if (!kanjiPathsCache[q.char]) prefetchQueue.push(q.char); });
      let pool = kanjiList.filter(k => k.baseGrade === grade && !appState.mastered.includes(k.char));
      pool.sort(() => Math.random() - 0.5);
      pool.forEach(k => { if (!kanjiPathsCache[k.char] && !prefetchQueue.includes(k.char)) { prefetchQueue.push(k.char); } });
      startPrefetching();
    }

    function el(id) { return document.getElementById(id); }
    function setStyle(id, prop, val) { const element = el(id); if (element) element.style[prop] = val; }
    function setDisplay(id, val) { setStyle(id, 'display', val); }

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playTone(freq, type, duration, vol = 0.1) {
      if(!audioCtx) return;
      try {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + duration);
      } catch(e) {}
    }
    function playPingPong() { initAudio(); playTone(659.25, 'sine', 0.15, 0.1); setTimeout(() => playTone(880.00, 'sine', 0.3, 0.1), 100); }
    function playBuzzer() { initAudio(); playTone(150, 'square', 0.2, 0.05); }
    function playFanfare() { initAudio(); [0, 150, 300, 500].forEach((t, i) => { const f = [523.25, 659.25, 783.99, 1046.50][i]; setTimeout(() => playTone(f, 'sine', 0.4, 0.15), t); }); }

    function burstConfetti() {
      const canvas = el('confettiCanvas'); if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      const particles = Array.from({length: 60}, () => ({
        x: canvas.width / 2, y: canvas.height / 2, r: Math.random() * 8 + 4, dx: Math.random() * 10 - 5, dy: Math.random() * -10 - 5,
        color: ['#fce7f3', '#fef08a', '#bae6fd', '#a7f3d0', '#c7d2fe'][Math.floor(Math.random() * 5)],
        tiltAngleIncrement: (Math.random() * 0.07) + 0.05, tiltAngle: 0
      }));
      function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); let active = 0;
        particles.forEach(p => {
          p.tiltAngle += p.tiltAngleIncrement; p.y += (Math.cos(p.tiltAngle) + 1 + p.r / 2) / 2; p.x += Math.sin(p.tiltAngle) * 2 + p.dx;
          p.dy += 0.1; p.y += p.dy; if (p.y <= canvas.height) active++;
          ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color; ctx.moveTo(p.x + p.r, p.y); ctx.lineTo(p.x, p.y + p.r); ctx.stroke();
        });
        if (active > 0) requestAnimationFrame(render);
      }
      render();
    }

    function getCircleNum(num) {
      if (num >= 7 && num < 99) return "㊥";
      const circles = ["", "①", "②", "③", "④", "⑤", "⑥"];
      return circles[num] || "";
    }

    function parseKanjiData() {
      kanjiStore = {}; 
      // 先頭のヘッダーを削除し、学年ごとに分割する
      let rawData = KANJI_DATA_RAW.replace(/^学年漢字音読み訓読み/, "");
      const lines = rawData.split(/(?=\d年生(?:(?:\(追加\))?))/).filter(line => line.trim() !== "");

      lines.forEach(line => {
        line = line.trim(); if(!line) return;
        const match = line.match(/^(\d)年生(?:\(追加\))?\s*(\S)(.*)$/); 
        if(!match) return;
        const grade = parseInt(match[1], 10); 
        const char = match[2]; 
        const readings = match[3];

        if (!kanjiStore[char]) { kanjiStore[char] = { baseGrade: grade, on: [], kun: [] }; }

        const onMatch = readings.match(/^[ア-ンヴー、,]+/);
        let onPart = onMatch ? onMatch[0] : "";
        let kunPart = readings.substring(onPart.length);

        const splitReadings = (str) => str.replace(/^[ー\-\s,、]+/, "").split(/[、,]/).filter(s => s.trim() !== "");

        // 後の学年で追加される読みを優先しマーカーを保持するロジック
        splitReadings(onPart).forEach(v => {
          const existing = kanjiStore[char].on.find(o => o.v === v);
          if (existing) {
            if (grade > existing.g) existing.g = grade;
          } else {
            kanjiStore[char].on.push({ v, g: grade });
          }
        });
        splitReadings(kunPart).forEach(v => {
          const existing = kanjiStore[char].kun.find(o => o.v === v);
          if (existing) {
            if (grade > existing.g) existing.g = grade;
          } else {
            kanjiStore[char].kun.push({ v, g: grade });
          }
        });
      });
      kanjiList = Object.entries(kanjiStore).map(([char, data]) => ({ char, ...data }));
    }

    async function fetchKanjiVG(char) {
      if (kanjiPathsCache[char]) return kanjiPathsCache[char];
      const hex = char.charCodeAt(0).toString(16).padStart(5, '0');
      // URLを正しい形式に修正
      const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
      try {
        const res = await fetch(url); if (!res.ok) throw new Error('Network error');
        const text = await res.text(); const doc = new DOMParser().parseFromString(text, 'image/svg+xml');
        const paths = Array.from(doc.querySelectorAll('path')).map(p => p.getAttribute('d')).filter(Boolean);
        kanjiPathsCache[char] = paths; return paths;
      } catch (e) { return null; }
    }

    function init() {
      writeCanvas = el('writeCanvas'); inkCanvas = el('inkCanvas'); guideCanvas = el('guideCanvas');
      if (!writeCanvas) return;
      ctxW = writeCanvas.getContext('2d'); ctxInk = inkCanvas.getContext('2d'); ctxGuide = guideCanvas.getContext('2d');
      if (kanjiList.length === 0) parseKanjiData();
      const saved = localStorage.getItem('kanji_app_mastered_list'); if (saved) { try { appState.mastered = JSON.parse(saved); } catch(e){} }
      const savedGrade = localStorage.getItem('kanji_app_grade'); if (savedGrade) { appState.selectedGrade = parseInt(savedGrade, 10); }
      setupEvents(); selectRandomKanji(); window.addEventListener('resize', resizeCanvas);
      updateSliderBg(); queuePrefetch(appState.selectedGrade);
    }

    function updateSliderBg() {
      const slider = el('speedSlider'); if (!slider) return;
      const val = (slider.value - slider.min) / (slider.max - slider.min) * 100;
      slider.style.background = `linear-gradient(to right, #38bdf8 0%, #38bdf8 ${val}%, #e2e8f0 ${val}%, #e2e8f0 100%)`;
    }

    async function selectSpecificKanji(char) {
      if (!char) return;
      let selected = kanjiList.find(k => k.char === char);
      if (!selected) {
        selected = { char: char, baseGrade: 99, on: [], kun: [{ v: "？？", g: 99 }] };
        if(!kanjiStore[char]) kanjiStore[char] = selected;
      }
      appState.selectedGrade = selected.baseGrade;
      localStorage.setItem('kanji_app_grade', appState.selectedGrade);
      appState.currentKanji = selected; appState.currentStroke = 0; appState.hasMistaken = false;
      if (ctxW) ctxW.clearRect(0, 0, writeCanvas.width, writeCanvas.height);
      if (ctxInk) ctxInk.clearRect(0, 0, inkCanvas.width, inkCanvas.height);
      stopPractice(); closeAnime(); updateGradeButtons();
      const statusEl = el('testStatus'); if (statusEl) statusEl.innerText = "よみこみ中...";
      const paths = await fetchKanjiVG(char);
      if (!paths || paths.length === 0) { if(statusEl) statusEl.innerText = "データが ありません"; return; }
      appState.currentKanji.paths = paths;
      setTimeout(() => { resizeCanvas(); updateUI(); }, 50);
    }

    async function selectRandomKanji() {
      appState.reviewQueue.forEach(q => q.wait--);
      let targetChar = null;
      const reviewTarget = appState.reviewQueue.find(q => q.wait <= 0 && !appState.mastered.includes(q.char));
      if (reviewTarget) { targetChar = reviewTarget.char; appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== targetChar); }
      let selected;
      if (targetChar) { selected = kanjiList.find(k => k.char === targetChar); }
      if (!selected) {
        let pool = kanjiList.filter(k => k.baseGrade === appState.selectedGrade && !appState.mastered.includes(k.char));
        if (appState.currentKanji) pool = pool.filter(k => k.char !== appState.currentKanji.char);
        if (pool.length === 0) pool = kanjiList.filter(k => k.baseGrade === appState.selectedGrade);
        if (pool.length === 0) { if (appState.selectedGrade !== 1) { changeGrade(1); } return; }
        selected = pool[Math.floor(Math.random() * pool.length)];
      }
      selectSpecificKanji(selected.char);
    }

    function changeGrade(g) { appState.selectedGrade = g; localStorage.setItem('kanji_app_grade', g); selectRandomKanji(); queuePrefetch(g); }
    
    function updateGradeButtons() {
      for(let i=1; i<=6; i++) {
        const btn = el('gb' + i); if (!btn) continue;
        if (i === appState.selectedGrade) btn.classList.add('active'); else btn.classList.remove('active');
      }
    }
    
    function resizeCanvas() {
      const grid = el('writeGrid'); if (!grid || !writeCanvas) return;
      const size = grid.clientHeight; if (size === 0) return;
      [writeCanvas, inkCanvas, guideCanvas].forEach(c => { c.width = size; c.height = size; });
      redrawGuide(); redrawInk();
    }
    
    function redrawGuide() {
      if (!appState.currentKanji || !guideCanvas || !appState.currentKanji.paths) return;
      const size = guideCanvas.width; ctxGuide.clearRect(0, 0, size, size);
      ctxGuide.save(); ctxGuide.scale(size/109, size/109); ctxGuide.strokeStyle = "#e2e8f0"; ctxGuide.lineWidth = 6; ctxGuide.lineCap = 'round'; ctxGuide.lineJoin = 'round';
      appState.currentKanji.paths.forEach(p => { ctxGuide.stroke(new Path2D(p)); });
      ctxGuide.restore();
    }
    
    function renderReadings(containerId, list, baseGrade) {
      const container = el(containerId); if (!container) return;
      container.innerHTML = '';
      if(list.length === 0) { container.innerHTML = '<div class="vertical-text opacity-30">-</div>'; return; }
      list.slice(0, 3).forEach(item => {
        const div = document.createElement('div'); div.className = 'vertical-text';
        // ご要望の修正: マーカーがない読みの頭を全角スペースで揃える
        const marker = (item.g > baseGrade) ? getCircleNum(item.g) : "　";
        div.innerText = marker + item.v; container.appendChild(div);
      });
    }

    function getPathStartPoint(pathStr) {
      const svg = el('animeSvg'); const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", pathStr); svg.appendChild(path); const start = path.getPointAtLength(0); svg.removeChild(path);
      return { x: start.x, y: start.y };
    }

    function updateUI() {
      const k = appState.currentKanji; if (!k || !k.paths) return;
      const infoSvg = el('infoKanjiSvg');
      if (infoSvg) {
        infoSvg.innerHTML = '';
        k.paths.forEach(p => {
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", p); path.setAttribute("class", "info-stroke-path"); infoSvg.appendChild(path);
        });
      }
      const gradeLabel = el('currentGradeLabel');
      if (gradeLabel) {
        if (k.baseGrade <= 6) gradeLabel.innerText = k.baseGrade + "ねんせいでならうかん字";
        else gradeLabel.innerText = "とくべつな かん字";
      }
      redrawGuide();
      const stText = el('strokeCountText'); if (stText) stText.textContent = k.paths.length;
      renderReadings('kunReadings', k.kun, k.baseGrade); renderReadings('onReadings', k.on, k.baseGrade);
      renderMasteredList();
      
      const animeBgGroup = el('animeBgGroup'); const strkGrp = el('strokeGroup'); const numGrp = el('numberGroup'); 
      if (!animeBgGroup || !strkGrp || !numGrp) return;
      animeBgGroup.innerHTML = ''; strkGrp.innerHTML = ''; numGrp.innerHTML = ''; 
      const placedPositions = [];
      k.paths.forEach((p, i) => {
        const bgPath = document.createElementNS("http://www.w3.org/2000/svg", "path"); bgPath.setAttribute("d", p); bgPath.setAttribute("class", "bg-stroke-path"); animeBgGroup.appendChild(bgPath);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", p); path.setAttribute("class", "stroke-path"); path.id = `anime-s-${i}`; path.style.strokeDasharray = "1000"; path.style.strokeDashoffset = "1000"; strkGrp.appendChild(path);
        const startPt = getPathStartPoint(p);
        let baseX = Math.max(8, Math.min(101, startPt.x - 12));
        let baseY = Math.max(8, Math.min(101, startPt.y - 12));
        let cx = baseX, cy = baseY;
        const minDistance = 13;
        let collision = true, angle = 0, radius = 0, step = 0;
        while (collision && step < 50) {
          collision = false;
          if (cx < 8 || cx > 101 || cy < 8 || cy > 101) collision = true;
          if (!collision) { for (let j = 0; j < placedPositions.length; j++) { if (Math.hypot(cx - placedPositions[j].x, cy - placedPositions[j].y) < minDistance) { collision = true; break; } } }
          if (collision) { step++; angle += Math.PI / 3; if (step % 6 === 0) radius += 6; cx = baseX + Math.cos(angle) * (6 + radius); cy = baseY + Math.sin(angle) * (6 + radius); }
        }
        cx = Math.max(8, Math.min(101, cx)); cy = Math.max(8, Math.min(101, cy));
        placedPositions.push({x: cx, y: cy});
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g"); g.id = `anime-num-${i}`; g.style.opacity = "0"; g.style.transition = "opacity 0.2s ease-in";
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle"); circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", "5.5"); circle.setAttribute("fill", "#ffffff"); circle.setAttribute("stroke", "#f97316"); circle.setAttribute("stroke-width", "1.2");
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.setAttribute("x", cx); text.setAttribute("y", cy + 0.5); text.setAttribute("dominant-baseline", "central"); text.setAttribute("text-anchor", "middle"); text.setAttribute("font-size", "6"); text.setAttribute("font-weight", "900"); text.setAttribute("fill", "#f97316"); text.style.fontFamily = "sans-serif"; text.textContent = (i + 1).toString();
        g.appendChild(circle); g.appendChild(text); numGrp.appendChild(g);
      });
    }

    function startPractice() {
      initAudio(); appState.isPracticing = true; appState.currentStroke = 0;
      ['kunCard', 'onCard', 'currentGradeLabelContainer', 'practiceControls'].forEach(id => setDisplay(id, 'none'));
      const spBtn = el('startPracticeBtn'); if (spBtn) spBtn.classList.add('hidden');
      const infoLabel = el('infoLabel'); if (infoLabel) infoLabel.style.visibility = 'hidden';
      ctxInk.clearRect(0,0,inkCanvas.width, inkCanvas.height); ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height);
      const wa = el('writeArea'); if (wa) wa.classList.remove('locked');
      const cb = el('clearBtn'); if (cb) cb.classList.remove('locked');
      const statusEl = el('testStatus'); if (statusEl) { statusEl.innerText = "１かくめ をかこう！"; statusEl.className = "text-[10px] md:text-xs font-black text-white bg-orange-400 px-2 py-0.5 md:px-4 md:py-1.5 rounded-full shadow-md"; }
      playTone(440, 'sine', 0.1);
    }

    function restartPractice() { if (appState.isPracticing) { appState.hasMistaken = true; startPractice(); } }
    function stopPractice() {
      appState.isPracticing = false; 
      const wa = el('writeArea'); if (wa) wa.classList.add('locked');
      const cb = el('clearBtn'); if (cb) cb.classList.add('locked');
      ['kunCard', 'onCard', 'practiceControls'].forEach(id => setDisplay(id, 'flex'));
      setDisplay('currentGradeLabelContainer', 'block');
      const infoLabel = el('infoLabel'); if (infoLabel) infoLabel.style.visibility = 'visible';
      const statusEl = el('testStatus'); if (statusEl) { statusEl.innerText = "ロック中 🔒"; statusEl.className = "text-[10px] md:text-xs font-black text-slate-400 bg-slate-100 px-2 py-0.5 md:px-4 md:py-1.5 rounded-full shadow-inner"; }
      const spBtn = el('startPracticeBtn'); if (spBtn) spBtn.classList.remove('hidden');
      const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.add('hidden');
      const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.remove('hidden');
    }

    function handleMistake(msg) {
      appState.hasMistaken = true; const statusEl = el('testStatus'); if (!statusEl) return;
      statusEl.innerText = msg; statusEl.className = "text-[10px] md:text-xs font-black text-white bg-rose-400 px-2 py-0.5 md:px-4 md:py-1.5 rounded-full shadow-md";
      playBuzzer(); setDisplay('practiceControls', 'flex');
      const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.add('hidden');
      const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.remove('hidden');
    }

    async function playAnime() {
      if (appState.animeIsRunning) return;
      initAudio(); appState.animeIsRunning = true; const paths = appState.currentKanji.paths;
      const speed = el('speedSlider').value; const durationMs = (11 - speed) * 150; 
      paths.forEach((_, i) => { const pEl = el(`anime-s-${i}`); if(pEl) { pEl.style.transition = 'none'; pEl.style.strokeDashoffset = "1000"; } const nEl = el(`anime-num-${i}`); if(nEl) { nEl.style.opacity = "0"; } });
      for(let i=0; i<paths.length; i++) {
        const pEl = el(`anime-s-${i}`); if (!pEl) continue;
        const nEl = el(`anime-num-${i}`); if (nEl) nEl.style.opacity = "1";
        await new Promise(r => setTimeout(r, 100));
        pEl.style.transition = `stroke-dashoffset ${durationMs}ms ease-in-out`; pEl.getBoundingClientRect(); pEl.style.strokeDashoffset = "0";
        playTone(500 + (i*50), 'triangle', durationMs/1000, 0.05); await new Promise(r => setTimeout(r, durationMs + 200));
      }
      appState.animeIsRunning = false;
    }

    function getStartEndPoints(pathStr) {
      const svg = el('animeSvg'); const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", pathStr); svg.appendChild(path); const len = path.getTotalLength(); const start = path.getPointAtLength(0); const end = path.getPointAtLength(len);
      svg.removeChild(path); return { s: { x: start.x / 109, y: start.y / 109 }, e: { x: end.x / 109, y: end.y / 109 } };
    }

    let drawing = false; let lastX, lastY; const TOLERANCE = 0.15; 
    function startDraw(e) {
      if (!appState.isPracticing) return;
      const rect = writeCanvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      const strokes = appState.currentKanji.paths; if(appState.currentStroke >= strokes.length) return;
      const target = getStartEndPoints(strokes[appState.currentStroke]).s;
      const dist = Math.hypot(x / writeCanvas.width - target.x, y / writeCanvas.height - target.y);
      if (dist > TOLERANCE) { handleMistake("かきはじめが ちがうよ💦"); return; }
      drawing = true; lastX = x; lastY = y;
      ctxW.lineCap = 'round'; ctxW.lineJoin = 'round'; ctxW.lineWidth = writeCanvas.width * 0.06; ctxW.strokeStyle = "rgba(14, 165, 233, 0.7)"; ctxW.beginPath(); ctxW.moveTo(x, y); ctxW.stroke();
    }
    
    function draw(e) {
      if (!drawing) return;
      const rect = writeCanvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctxW.beginPath(); ctxW.moveTo(lastX, lastY); ctxW.lineTo(x, y); ctxW.stroke(); lastX = x; lastY = y;
    }
    
    function endDraw() {
      if (!drawing) return; drawing = false;
      const strokes = appState.currentKanji.paths; const target = getStartEndPoints(strokes[appState.currentStroke]).e;
      const dist = Math.hypot(lastX / writeCanvas.width - target.x, lastY / writeCanvas.height - target.y);
      if (dist < TOLERANCE) {
        appState.currentStroke++; redrawInk(); ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height);
        if (appState.currentStroke >= strokes.length) {
          setDisplay('practiceControls', 'flex'); const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.remove('hidden'); const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.add('hidden');
          const statusEl = el('testStatus');
          if (!appState.hasMistaken) {
            if (statusEl) { statusEl.innerText = "💮 クリア！"; statusEl.className = "text-[10px] md:text-xs font-black text-white bg-emerald-500 px-2 py-0.5 md:px-4 md:py-1.5 rounded-full shadow-lg"; }
            playFanfare(); burstConfetti(); showExcellentPopup();
            if (!appState.mastered.includes(appState.currentKanji.char)) { 
              appState.mastered.push(appState.currentKanji.char); localStorage.setItem('kanji_app_mastered_list', JSON.stringify(appState.mastered)); 
              appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== appState.currentKanji.char);
              setTimeout(() => { hideExcellentPopup(); flyToCollection(appState.currentKanji.char); }, 1500);
            } else { appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== appState.currentKanji.char); setTimeout(() => { hideExcellentPopup(); renderMasteredList(); }, 1500); }
          } else {
            if (statusEl) { statusEl.innerText = "つぎは いっかいで かこう！"; statusEl.className = "text-[10px] md:text-xs font-black text-white bg-orange-500 px-2 py-0.5 md:px-4 md:py-1.5 rounded-full shadow-lg"; }
            playPingPong(); const existing = appState.reviewQueue.find(q => q.char === appState.currentKanji.char);
            if (existing) existing.wait = 3; else appState.reviewQueue.push({ char: appState.currentKanji.char, wait: 3 });
          }
        } else { const statusEl = el('testStatus'); if (statusEl) statusEl.innerText = (appState.currentStroke + 1) + "かくめ をかこう！"; playPingPong(); }
      } else { ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height); handleMistake("さいごまで なぞってね💦"); }
    }

    function redrawInk() {
      const size = inkCanvas.width; ctxInk.clearRect(0,0,size,size); if (appState.currentStroke === 0) return;
      ctxInk.save(); ctxInk.scale(size/109, size/109); ctxInk.strokeStyle = "#000000"; ctxInk.lineWidth = 6; ctxInk.lineCap = 'round'; ctxInk.lineJoin = 'round';
      const strokes = appState.currentKanji.paths; for(let i=0; i<appState.currentStroke; i++) ctxInk.stroke(new Path2D(strokes[i]));
      ctxInk.restore();
    }

    function closeAnime() { const af = el('animeFrame'); if (af) af.classList.add('hidden'); setDisplay('infoFrame', 'flex'); if (appState.isPracticing) restartPractice(); }

    function setupEvents() {
      el('startPracticeBtn').onclick = startPractice; el('closeAnimeBtn').onclick = closeAnime; el('playBtn').onclick = playAnime; el('showAnimeBtn').onclick = () => { setDisplay('infoFrame', 'none'); el('animeFrame').classList.remove('hidden'); }; el('clearBtn').onclick = restartPractice; el('submitBtn').onclick = selectRandomKanji; el('skipToNextBtn').onclick = selectRandomKanji; el('resetAllBtn').onclick = () => { if(confirm("データを けしますか？")) { localStorage.clear(); location.reload(); } };
      const triggerSearch = () => { const val = el('searchInput').value.trim(); if (val) selectSpecificKanji(val); el('searchInput').value = ""; };
      el('searchBtn').onclick = triggerSearch; el('searchInput').onkeypress = (e) => { if (e.key === 'Enter') triggerSearch(); };
      const slider = el('speedSlider'); if (slider) slider.addEventListener('input', updateSliderBg);
      const preventDefault = (e) => { e.preventDefault(); };
      
      // 右クリック（コンテキストメニュー）を禁止
      window.addEventListener('contextmenu', preventDefault);

      writeCanvas.addEventListener('mousedown', startDraw); writeCanvas.addEventListener('mousemove', draw); writeCanvas.addEventListener('mouseup', endDraw); writeCanvas.addEventListener('mouseleave', endDraw);
      writeCanvas.addEventListener('touchstart', (e) => { preventDefault(e); startDraw(e); }, {passive: false}); writeCanvas.addEventListener('touchmove', (e) => { preventDefault(e); draw(e); }, {passive: false}); writeCanvas.addEventListener('touchend', endDraw, {passive: false});
    }

    function renderMasteredList() {
      const container = el('masteredList'); if (!container) return; container.innerHTML = '';
      const gradeKanjiList = kanjiList.filter(k => k.baseGrade === appState.selectedGrade);
      const totalInGrade = gradeKanjiList.length; const masteredInGradeCount = gradeKanjiList.filter(k => appState.mastered.includes(k.char)).length;
      const progressEl = el('gradeProgress'); if (progressEl) { if (appState.selectedGrade <= 6) progressEl.innerText = `${masteredInGradeCount} ／ ${totalInGrade} 字`; else progressEl.innerText = "とくべつ"; }
      const masteredToShow = appState.mastered.filter(char => { const kData = kanjiStore[char]; if (appState.selectedGrade <= 6) return kData && kData.baseGrade === appState.selectedGrade; return !kData || kData.baseGrade > 6; }).reverse();
      masteredToShow.forEach(c => {
        const d = document.createElement('div'); d.className = 'w-6 h-6 md:w-9 md:h-9 bg-white border-2 border-amber-300 rounded-full flex items-center justify-center kyokasho text-[10px] md:text-base font-black text-amber-700 shadow-sm shrink-0'; d.innerText = c; container.appendChild(d);
      });
      const countEl = el('masterTotalCount'); if (countEl) countEl.textContent = appState.mastered.length;
    }

    function showExcellentPopup() { const popup = el('excellentPopup'); if (!popup) return; popup.classList.remove('opacity-0', 'scale-50'); popup.classList.add('opacity-100', 'scale-100'); }
    function hideExcellentPopup() { const popup = el('excellentPopup'); if (!popup) return; popup.classList.remove('opacity-100', 'scale-100'); popup.classList.add('opacity-0', 'scale-50'); }

    function flyToCollection(char) {
      const sourceGrid = document.querySelector('.kanji-grid'); if (!sourceGrid) { renderMasteredList(); return; }
      const sourceRect = sourceGrid.getBoundingClientRect(); const targetList = el('masteredList'); if (!targetList) { renderMasteredList(); return; }
      const targetRect = targetList.getBoundingClientRect(); const flier = document.createElement('div');
      flier.className = 'fixed z-[150] kyokasho text-amber-500 bg-white border-4 border-amber-300 rounded-full flex items-center justify-center shadow-xl font-black';
      flier.style.width = sourceRect.width + 'px'; flier.style.height = sourceRect.height + 'px';
      flier.style.left = sourceRect.left + 'px'; flier.style.top = sourceRect.top + 'px';
      flier.style.fontSize = (sourceRect.height * 0.7) + 'px'; flier.style.lineHeight = '1';
      flier.innerText = char; document.body.appendChild(flier);
      const targetCenterX = targetRect.left + 26; const targetCenterY = targetRect.top + 26;
      const sourceCenterX = sourceRect.left + sourceRect.width / 2; const sourceCenterY = sourceRect.top + sourceRect.height / 2;
      const translateX = targetCenterX - sourceCenterX; const translateY = targetCenterY - sourceCenterY;
      const targetScale = 36 / sourceRect.width;
      const anim = flier.animate([ { transform: 'translate(0px, 0px) scale(1) rotate(0deg)', opacity: 1 }, { transform: `translate(${translateX}px, ${translateY}px) scale(${targetScale}) rotate(360deg)`, opacity: 0 } ], { duration: 1200, easing: 'ease-in', fill: 'forwards' });
      anim.onfinish = () => { playTone(880, 'sine', 0.1); setTimeout(() => playTone(1108.73, 'sine', 0.15), 80); flier.remove(); renderMasteredList(); };
    }

    window.onload = () => { init(); setTimeout(() => { setStyle('appBody', 'opacity', '1'); }, 100); };
  </script>
</body>
</html>
