<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ＡＩかん字マスター</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=block" rel="stylesheet">
  <style>
    :root {
      --bg-color: #fffbeb;
      --ink-black: #1e293b;
      --ink-blue: #0ea5e9;
      --grid-line: #bae6fd;
      --btn-shadow: #0f172a20;
    }
    body {
      font-family: 'Klee One', "UD デジタル 教科書体 N-R", "UD Digi Kyokasho N-R", "HG正楷書体-PRO", "HGKyokashotai", serif; 
      font-weight: 600;
      background-color: var(--bg-color);
      color: #334155;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      touch-action: none;
      opacity: 0; 
      transition: opacity 0.5s ease-in-out;
    }
    
    .kyokasho { font-family: inherit; }
    
    .kanji-grid {
      position: relative;
      background-color: #ffffff;
      border: 4px solid #cbd5e1;
      border-radius: 1.5rem;
      box-shadow: 0 8px 20px var(--btn-shadow);
      overflow: hidden;
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
    }
    .grid-line-v {
      position: absolute; top: 0; left: 50%; width: 0; height: 100%;
      border-left: 2px dashed var(--grid-line);
      pointer-events: none; z-index: 1;
    }
    .grid-line-h {
      position: absolute; top: 50%; left: 0; width: 100%; height: 0;
      border-top: 2px dashed var(--grid-line);
      pointer-events: none; z-index: 1;
    }
    .reading-card {
      border-radius: 1.25rem;
      border: 3px solid var(--grid-line);
      background: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 6.8rem;
      box-shadow: 0 4px 10px var(--btn-shadow);
      flex-shrink: 0;
    }
    .reading-columns {
      display: flex;
      flex-direction: row-reverse;
      justify-content: center;
      gap: 0.25rem;
      flex: 1;
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
    }
    .vertical-text {
      writing-mode: vertical-rl;
      font-weight: 800;
      line-height: 1.4;
      font-size: 1.25rem;
      white-space: nowrap;
      letter-spacing: 0.1em;
    }
    .btn-action {
      transition: all 0.1s ease;
      border-bottom-width: 6px;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-action:active { transform: translateY(4px); border-bottom-width: 2px; }
    .grade-btn {
      width: 32px; height: 32px; border-radius: 50%; font-size: 0.9rem; font-weight: 900;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      border-bottom: 3px solid #00000020;
    }
    .grade-btn.active {
      background-color: #6366f1; color: white; transform: scale(1.1); border-bottom: 3px solid #4338ca;
    }
    #speedSlider {
      -webkit-appearance: none; width: 100%; height: 16px; border-radius: 8px;
      background: #e2e8f0; outline: none; transition: background 0.1s;
    }
    #speedSlider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 34px; height: 34px; background: #ffffff;
      border-radius: 50%; cursor: pointer; border: 4px solid #38bdf8; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .locked { opacity: 0.5; filter: grayscale(0.8); pointer-events: none; transition: all 0.3s; }
    .scroll-hide::-webkit-scrollbar { display: none; }
    .info-stroke-path { stroke: #334155; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .bg-stroke-path { stroke: #f1f5f9; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    .stroke-path { stroke: #000000; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    #confettiCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
  </style>
</head>
<body id="appBody" class="p-1 md:p-2 box-border">
  <canvas id="confettiCanvas"></canvas>

  <div id="excellentPopup" class="fixed inset-0 pointer-events-none z-[200] flex items-center justify-center opacity-0 scale-50 transition-all duration-500">
    <div class="bg-white/95 backdrop-blur-sm px-8 py-6 rounded-3xl shadow-2xl border-4 border-emerald-400 transform -rotate-2">
      <span class="text-4xl md:text-7xl font-black text-emerald-500 drop-shadow-sm tracking-widest leading-none">💮よくできました</span>
    </div>
  </div>

  <header class="h-16 shrink-0 flex items-center justify-between bg-white px-4 rounded-xl shadow-sm border-b-4 border-slate-200 mb-2 z-10 relative overflow-x-auto scroll-hide">
    <div class="flex-1 flex items-center justify-center gap-4 md:gap-8 min-w-max">
      <h1 class="text-xl md:text-3xl font-black text-indigo-600 tracking-tighter shrink-0 drop-shadow-sm">ＡＩかん字マスター</h1>
      
      <div class="flex items-center gap-3">
        <div id="gradeButtons" class="flex gap-1.5 bg-slate-100 p-1.5 rounded-full shadow-inner">
          <button onclick="changeGrade(1)" id="gb1" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">1</button>
          <button onclick="changeGrade(2)" id="gb2" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">2</button>
          <button onclick="changeGrade(3)" id="gb3" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">3</button>
          <button onclick="changeGrade(4)" id="gb4" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">4</button>
          <button onclick="changeGrade(5)" id="gb5" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">5</button>
          <button onclick="changeGrade(6)" id="gb6" class="grade-btn bg-white text-slate-500 hover:bg-indigo-50">6</button>
        </div>

        <div class="flex items-center gap-1 bg-slate-100 p-1.5 rounded-full border-2 border-transparent focus-within:border-indigo-300 transition-all shadow-inner">
          <input type="text" id="searchInput" maxlength="1" placeholder="さがす" class="w-10 md:w-14 bg-transparent text-center font-black text-indigo-600 focus:outline-none placeholder:text-slate-300">
          <button id="searchBtn" class="bg-indigo-500 text-white w-7 h-7 rounded-full flex items-center justify-center hover:bg-indigo-600 active:scale-90 transition-all shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="bg-amber-100 text-amber-600 px-3 py-1.5 rounded-full font-black text-sm shadow-inner shrink-0 ml-3">
      🏆 <span id="masterTotalCount">0</span>
    </div>
  </header>

  <main class="flex-1 flex flex-col md:flex-row gap-2 md:gap-3 min-h-0 overflow-hidden z-10 relative">
    <section class="flex-1 bg-white rounded-3xl shadow-lg border-4 border-sky-100 flex flex-col p-3 overflow-hidden relative">
      <div id="infoFrame" class="absolute inset-0 flex flex-col p-3 transition-opacity duration-300">
        <div class="text-center shrink-0 mb-2 mt-0" id="currentGradeLabelContainer">
          <div id="currentGradeLabel" class="text-indigo-500 font-black text-lg md:text-xl tracking-widest leading-none">１ねんせいでならうかん字</div>
        </div>

        <div id="infoLabel" class="flex justify-end items-center mb-1 shrink-0">
          <div class="bg-indigo-600 px-5 py-2 rounded-2xl text-white shadow-md flex items-baseline gap-1">
            <span id="strokeCountText" class="text-2xl md:text-3xl font-black">-</span>
            <span class="text-sm font-bold opacity-90">画</span>
          </div>
        </div>
        
        <div class="flex-1 flex items-center justify-center min-h-0 gap-3 w-full py-1 mx-auto max-w-[800px]">
          <div id="kunCard" class="reading-card border-sky-100 text-sky-700 h-full max-h-[420px]">
            <span class="text-xs font-black my-2 bg-sky-50 text-sky-600 px-3 py-1 rounded-full border border-sky-200 shrink-0">くんよみ</span>
            <div id="kunReadings" class="reading-columns scroll-hide w-full flex-1"></div>
          </div>
          
          <div class="h-full aspect-square max-h-[420px] flex-shrink-0">
            <div class="kanji-grid border-slate-100">
              <div class="grid-line-v"></div><div class="grid-line-h"></div>
              <svg id="infoKanjiSvg" viewBox="0 0 109 109" class="w-full h-full absolute inset-0 z-10"></svg>
            </div>
          </div>
          
          <div id="onCard" class="reading-card border-rose-100 text-rose-700 h-full max-h-[420px]">
            <span class="text-xs font-black my-2 bg-rose-50 text-rose-600 px-3 py-1 rounded-full border border-rose-200 shrink-0">おんよみ</span>
            <div id="onReadings" class="reading-columns scroll-hide w-full flex-1"></div>
          </div>
        </div>

        <div id="practiceControls" class="mt-2 shrink-0 flex flex-col gap-1">
          <button id="submitBtn" class="bg-sky-400 text-white py-3 rounded-xl text-xl font-black shadow-lg border-b-6 border-sky-600 btn-action hover:bg-sky-500">
            つぎの かん字 ➡
          </button>
          <button id="showAnimeBtn" class="hidden bg-rose-500 text-white py-3 rounded-xl text-xl font-black shadow-lg border-b-6 border-rose-700 btn-action hover:bg-rose-600 animate-pulse">
            👀 かきじゅんをみる
          </button>
        </div>
      </div>

      <div id="animeFrame" class="hidden absolute inset-0 flex flex-col bg-sky-50 z-20 p-3">
        <div class="flex justify-between items-center mb-2 shrink-0">
          <span class="text-xs font-bold text-sky-500 bg-white px-3 py-1 rounded-full shadow-sm">かきじゅん</span>
          <button id="closeAnimeBtn" class="bg-white text-slate-500 px-3 py-1 rounded-full font-bold text-xs border-2 border-slate-200 hover:text-rose-500 shadow-sm">✕ もどる</button>
        </div>
        <div class="flex-1 flex items-center justify-center min-h-0 w-full py-1">
          <div class="h-full aspect-square max-h-[420px]">
            <div class="kanji-grid border-sky-300 bg-white">
              <div class="grid-line-v"></div><div class="grid-line-h"></div>
              <svg id="animeSvg" viewBox="0 0 109 109" class="w-full h-full relative z-10">
                <g id="animeBgGroup"></g>
                <g id="strokeGroup"></g>
                <g id="numberGroup"></g>
              </svg>
            </div>
          </div>
        </div>
        <div class="mt-2 bg-white p-3 rounded-xl shadow-sm border-2 border-sky-100 flex flex-col gap-2 shrink-0">
          <div class="flex items-center gap-4 w-full">
            <button id="playBtn" class="shrink-0 bg-sky-400 text-white w-12 h-12 rounded-full font-bold text-2xl flex items-center justify-center shadow-lg border-b-4 border-sky-600 btn-action">▶</button>
            <div class="flex-1 flex flex-col">
              <input type="range" id="speedSlider" min="1" max="10" value="5" class="w-full">
              <div class="flex justify-between text-[10px] text-sky-400 font-bold mt-1 px-1">
                <span>🐢 ゆっくり</span>
                <span>はやい 🐇</span>
              </div>
            </div>
          </div>
        </div>
        <button id="skipToNextBtn" class="mt-2 bg-sky-400 text-white py-3 rounded-xl text-xl font-black shadow-lg border-b-6 border-sky-600 btn-action hover:bg-sky-500 shrink-0">
          つぎの かん字 ➡
        </button>
      </div>
    </section>

    <section id="writeSection" class="flex-1 bg-white rounded-3xl shadow-lg border-4 border-orange-100 flex flex-col p-3 relative overflow-hidden">
      <div class="flex justify-between items-center mb-1 shrink-0">
        <span class="text-xs font-bold text-orange-400 tracking-widest bg-orange-50 px-3 py-1 rounded-full">なぞりがき</span>
        <span id="testStatus" class="text-xs font-black text-slate-400 bg-slate-100 px-3 py-1 rounded-full shadow-inner">ロック中 🔒</span>
      </div>
      
      <div id="writeArea" class="flex-1 flex items-center justify-center min-h-0 relative locked w-full py-1">
        <div class="h-full aspect-square max-h-[420px]">
          <div id="writeGrid" class="kanji-grid border-orange-300">
            <div class="grid-line-v"></div><div class="grid-line-h"></div>
            <canvas id="guideCanvas" class="absolute inset-0 z-0 w-full h-full"></canvas>
            <canvas id="inkCanvas" class="absolute inset-0 z-10 w-full h-full"></canvas>
            <canvas id="writeCanvas" class="absolute inset-0 z-20 touch-none w-full h-full cursor-crosshair"></canvas>
          </div>
        </div>
      </div>
      
      <div class="mt-2 flex gap-2 shrink-0">
        <button id="clearBtn" class="flex-[1] bg-orange-50 text-orange-500 py-2 rounded-xl font-bold border-b-6 border-orange-200 btn-action locked flex flex-col leading-tight">
          <span class="text-base">やりなおし</span>
          <span class="text-[10px] opacity-70">最初から</span>
        </button>
        <button id="startPracticeBtn" class="flex-[2] bg-orange-400 text-white py-3 rounded-xl text-xl font-black shadow-lg border-b-6 border-orange-600 btn-action hover:bg-orange-500">
          れんしゅうする！
        </button>
      </div>
    </section>
  </main>

  <footer class="h-32 md:h-36 shrink-0 bg-white border-t-4 border-slate-100 flex flex-col px-3 py-1 z-10 relative">
    <div class="flex-1 flex items-center gap-3 min-h-0">
      <div class="flex flex-col items-center shrink-0">
        <div class="bg-amber-100 text-amber-600 border-b-4 border-amber-300 rounded-xl px-3 py-1.5 font-black text-xs text-center shadow-sm">
          マスターした<br>かん字
        </div>
        <div id="gradeProgress" class="mt-1 text-[10px] font-black text-slate-500 tracking-tighter">
          - / - 字
        </div>
      </div>
      <div id="masteredList" class="flex-1 flex flex-wrap gap-1.5 overflow-y-auto h-full content-start items-start py-1 scroll-hide"></div>
      <div class="shrink-0">
        <button id="resetAllBtn" class="text-[9px] text-slate-300 hover:text-rose-400 underline font-bold px-1">リセット</button>
      </div>
    </div>
    <div class="text-center text-[9px] text-slate-300 font-bold py-0.5 select-none pointer-events-none">
      ©2026　ＡＩかん字マスター　ＩＣＴ支援の杜
    </div>
  </footer>

  <script>
    // 学習指導要領 準拠 1,026文字データ
    const KANJI_DATA_RAW = `
1年生一イチ、イッひと（つ）
1年生右ウ、ユウみぎ
1年生雨ウあめ、あま
1年生円エンまる（い）
1年生王オウ-
1年生音オン、インね、おと
1年生下カ、ゲした、しも、もと、さ（げる）、さ（がる）、くだ（る）、くだ（す）、くだ（さる）、o（ろす）、o（りる）
1年生火カひ、ほ
1年生花カはな
1年生貝-かい
1年生学ガクまな（ぶ）
1年生気キ、ケ-
1年生九キュウ、クここの（つ）
1年生休キュウやす（む）、やす（まる）、やす（める）
1年生玉ギョクたま
1年生金キン、コンかね、かな
1年生空クウそら、あ（く）、あ（ける）、から
1年生月ゲツ、ガツつき
1年生犬ケンいぬ
1年生見ケンみ（る）、み（える）、み（せる）
1年生五ゴいつ（つ）
1年生口コウ、クくち
1年生校コウ-
1年生左サひだり
1年生三サンみ（つ）
1年生山サンやま
1年生子シ、スこ
1年生四シよ（つ）、よん
1年生糸シいと
1年生字ジあざ
1年生耳ジみみ
1年生七シチなな（つ）
1年生車シャくるま
1年生手シュて、た
1年生十ジュウ、ジッとお
1年生出シュツ、スイで（る）、だ（す）
1年生女ジョ、ニョおんな、め
1年生小ショウちい（さい）、こ、お
1年生上ジョウ、ショウうえ、うわ、かみ、あ（げる）、あ（がる）、のぼ（る）、のぼ（せる）、のぼ（す）
1年生森シンもり
1年生人ジン、ニンひと
1年生水スイみず
1年生正セイ、ショウただ（しい）、ただ（す）、まさ
1年生生セイ、ショウい（きる）、い（かす）、い（ける）、う（まれる）、う（む）、お（いる）、は（える）、は（やす）、き、なま
1年生青セイ、ショウあお
1年生夕セキゆう
1年生石セキ、シャク、コクいし
1年生赤セキ、シャクあか
1年生千センち
1年生川センかわ
1年生先センさき
1年生早ソウ、サッはや（い）、はや（める）
1年生草ソウくさ
1年生足ソクあし、た（る）、た（りる）、た（す）
1年生村ソンむら
1年生大ダイ、タイおお（きい）、おお（いに）
1年生男ダン、ナンおとこ
1年生竹チクたけ
1年生中チュウなか
1年生虫チュウむし
1年生町チョウまち
1年生天テンあめ、あま
1年生田デンた
1年生土ド、ドトつち
1年生二ニふた（つ）
1年生日ニチ、ジツひ、か
1年生入ニュウ、ジュはい（る）、い（れる）
1年生年ネンとし
1年生白ハク、ビャクしろ、しら
1年生八ハチや（つ）
1年生百ヒャク-
1年生文ブン、モンふみ
1年生木ボク、モクき、こ
1年生本ホンもと
1年生名メイ、ミョウな
1年生目モク、ボクめ、ま
1年生立リツ、リュウた（つ）、た（てる）
1年生力リョク、リキちから
1年生林リンはやし
1年生六ロクむ（つ）
2年生引インひ（く）、ひ（ける）
2年生羽ウはね、は
2年生雲ウンくも
2年生園エンその
2年生遠エン、オンとお（い）
2年生何カなに、なん
2年生科カ-
2年生夏カなつ
2年生家カ、ケいえ、や
2年生歌カうた、うた（う）
2年生画ガ、カえが（く）
2年生回カイ、エまわ（る）、まわ（す）
2年生会カイ、エあ（う）
2年生海カイうみ
2年生絵カイ、エ-
2年生外ガイ、ゲそと、ほか、はず（す）、はず（れる）
2年生角カクかど、つの
2年生楽ガク、ラクたの（しい）、たの（しむ）
2年生活カツ-
2年生間カン、ケンあいだ、ま
2年生丸ガンまる（い）、まる（める）
2年生岩ガンいわ
2年生顔ガンかお
2年生汽キ-
2年生記キしる（す）
2年生帰キかえ（る）、かえ（す）
2年生弓キュウゆみ
2年生牛ギュウうし
2年生魚ギョうお、さかな
2年生京キョウ、ケイみやこ
2年生強キョウ、ゴウつよ（い）、つよ（まる）、つよ（める）、し（いる）
2年生教キョウおし（える）、おそ（わる）
2年生近キンちか（い）
2年生兄キョウ、ケイあに
2年生形ケイ, ギョウかたち、なり
2年生計ケイはか（る）、はか（らう）
2年生元ゲン、ガンもと
2年生言ゲン、ゴンい（う）、こと
2年生原ゲンはら
2年生戸コと
2年生古コふる（い）、ふる（める）、ふる（まる）
2年生午ゴ-
2年生後後ゴ、コウのち、うしろ、あと、おく（れる）
2年生語ゴかた（る）、かた（らう）
2年生工コウ, ク-
2年生公コウおおやけ
2年生広コウひろ（い）、ひろ（まる）、ひろ（める）、ひろ（がる）、ひろ（げる）
2年生交コウまじ（わる）、まじ（える）、ま（じる）、ま（ざる）、ま（ぜる）、か（う）、か（わす）
2年生光コウひか（る）、ひかり
2年生考コウかんが（える）
2年生行コウ、ギョウ、アンい（く）、ゆ（く）、おこな（う）
2年生高コウたか（い）、たか（まる）、たか（める）
2年生黄コウ、オウき、こ
2年生合合ゴウ、ガッ、カッあ（う）、あ（わす）、あ（わせる）
2年生谷コクたに
2年生国コクくに
2年生黒コクくろ（い）
2年生今コン、キンいま
2年生才サイ-
2年生細サイほそ（い）、こま（か）、こま（かい）
2年生作サク, サつく（る）
2年生算サン-
2年生止シと（まる）、と（める）
2年生市シいち
2年生矢シや
2年生姉シあね
2年生思シ oも（う）
2年生紙シかみ
2年生寺ジてら
2年生自ジ、シみずか（ら）
2年生時ジとき
2年生室シツむろ
2年生社シャやしろ
2年生弱ジャクよわ（い）、よわ（る）、よわ（まる）、よわ（める）
2年生首シュくび
2年生秋シュウあき
2年生週シュウ-
2年生春シュンはる
2年生書ショか（く）
2年生少ショウすく（ない）、すこ（し）
2年生場ジョウば
2年生色ショク、シキいろ
2年生食ショク、ジキた（べる）、く（う）、く（らう）
2年生心シンこころ
2年生新シンあたら（しい）、あら（た）、あら（す）
2年生親シン oや,した（しい）
2年生図ズ,トはか（る）
2年生数スウ,ス,サクかず,かぞ（える）
2年生西セイ,サイにし
2年生声セイ,ショウこえ
2年生星セイほし
2年生晴セイは（れる）
2年生切セツき（る）,き（れる）
2年生雪セツゆき
2年生船センふね
2年生线セン-
2年生前ゼンまえ
2年生組ソくみ,く（む）
2年生走走ソウはし（る）
2年生多タおお（い）
2年生太タイふと（い）,ふと（る）
2年生体タイからだ
2年生台ダイ,タイ-
2年生地チ,ジ-
2年生池チいけ
2年生知知知し（る）
2年生茶チャ-
2年生昼チュウひる
2年生長チョウなが（い）
2年生鳥チョウとり
2年生朝朝チョウあさ
2年生直チョクなお（す）
2年生通ツウとお（る）,かよ（う）
2年生弟テイ,ダイおとうと
2年生店店テンみせ
2年生点点テン-
2年生電電デン-
2年生刀トウかたな
2年生冬冬トウふゆ
2年生当トウあ（たる）,あ（てる）
2年生東東トウひがし
2年生答トウこた（える）,こた（え）
2年生頭頭トウ,ズあたま
2年生同ドウ oな（じ）
2年生道道ドウみち
2年生読読ドクよ（む）
2年生内内ナイうち
2年生南南ナンみなみ
2年生肉肉ニク-
2年生馬馬バうま
2年生売売バイう（る）
2年生買買バイか（う）
2年生麦麦バクむぎ
2年生半半ハンなか（ば）
2年生番番番-
2年生父フちち
2年生風風フウかぜ
2年生分分ブン,フンわ（ける）,わ（かる）
2年生聞聞ブンき（く）,き（こえる）
2年生米米ベイ,マイこめ
2年生歩歩ホある（く）
2年生母母ボはは
2年生方方ホウかた
2年生北北ホクきた
2年生毎毎毎マイ-
2年生妹妹マイいもうと
2年生万万マン,バン-
2年生明明メイあか（るい）,あ（ける）
2年生鸣鸣メイな（く）,な（る）
2年生毛毛モウけ
2年生门門モンかど
2年生夜夜ヤよる
2年生野野ヤの
2年生友友ユウとも
2年生用用ヨウもち（いる）
2年生曜曜ヨウ-
2年生来来ライく（る）
2年生里里リさと
2年生理理リ-
2年生話話ワはな（す）,はな（し）
2年生(追加)雨ウあま
2年生(追加)音オン,インね
2年生(追加)下カ,ゲさ（がる）,くだ（る）
2年生(追加)花カ-
2年生(追加)学まな（ぶ）
2年生(追加)休キュウやす（まる）,やす（める）
2年生(追加)玉ギョク-
2年生(追加)金コンかな
2年生(追加)空あ（く）,あ（ける）,から
2年生(追加)見ケンみ（える）,み（せる）
2年生(追加)犬ケン-
2年生(追加)口コウ,ク-
2年生(追加)左サ-
2年生(追加)山サン-
2年生(追加)子シ,ス-
2年生(追加)糸シ-
2年生(追加)耳ジ-
2年生(追加)車シャ-
2年生(追加)手シュた
2年生(追加)出シュツ,スイ-
2年生(追加)女ジョ,ニョめ
2年生(追加)小ショウ-
2年生(追加)上ジョウ、ショウのぼ（る）、うわ,かみ
2年生(追加)森シン-
2年生(追加)正セイ,ショウただ（す）、まさ
2年生(追加)生セイ,ショウは（える）、なマ
2年生(追加)青セイ,ショウ-
2年生(追加)夕セキ-
2年生(追加)石セキ,シャク-
2年生(追加)赤セキ,シャク-
2年生(追加)川セン-
2年生(追加)先セン-
2年生(追加)早ソウ-
2年生(追加)草ソウ-
2年生(追加)足ソクた（りる）
2年生(追加)村ソン-
2年生(追加)男ダン,ナン-
2年生(追加)竹チク-
2年生(追加)虫チュウ-
2年生(追加)町チョウ-
2年生(追加)天あめ、あま
2年生(追加)田デン-
2年生(追加)土ド,ドト-
2年生(追加)白ハク,ビャクしら
2年生(追加)文モンふみ
2年生(追加)木ボク,モクこ
2年生(追加)名ミョウ-
2年生(追加)目モクま
2年生(追加)立リツ,リュウた（てる）
2年生(追加)力リョク,リキ-
2年生(追加)林リン-
3年生悪アク、オわる（い）
3年生安アンやす（い）
3年生暗アンくら（い）
3年生医イ-
3年生委イゆだ（ねる）
3年生意イ-
3年生育イクそだ（つ）、そだ（てる）、はぐく（む）
3年生員イン-
3年生院イン-
3年生飲インの（む）
3年生運ウンはこ（ぶ）
3年生泳エイ oよ（ぐ）
3年生駅エキ-
3年生央オウ-
3年生横オウよこ
3年生屋オクや
3年生温オンあたた（か）、あたた（かい）、あたた（まる）、あたた（める）
3年生化カ、ケば（ける）、ば（かす）
3年生荷カに
3年生界カイ-
3年生開カイひら（く）、ひら（ける）、あ（く）、あ（ける）
3年生階カイ-
3年生寒カンさむ（い）
3年生感カン-
3年生漢カン-
3年生館カンやかた
3年生岸ガンきし
3年生起オ（きる）、オ（こる）、オ（こす）
3年生期期キ,ゴ-
3年生客客キャク-
3年生究究キュウきわ（める）
3年生急急キュウいそ（ぐ）
3年生級級キュウ-
3年生宮宮キュウ,グウ,ク,ミヤみや
3年生球球キュウたま
3年生去去キョ,コさ（る）
3年生橋橋キョウはし
3年生業業ギョウ,ゴウわざ
3年生曲曲キョクま（がる）,ま（げる）
3年生局局キョク-
3年生銀銀ギン-
3年生区区ク-
3年生苦苦クくる（しい）,くる（しむ）,くる（しめる）,にが（い）,にが（む）
3年生具具グ-
3年生君君クンきみ
3年生係ケイかかり,かか（る）,かかわ（る）
3年生軽軽ケイかる（い）,かろ（やか）
3年生血血ケツち
3年生決決ケツき（める）,き（まる）
3年生研研ケンと（ぐ）
3年生県県ケン-
3年生庫庫コ,クくら
3年生湖湖コみずうみ
3年生向向コウむ（く）,む（ける）,む（かう）,む（こう）
3年生幸幸コウさいわ（い）,さち,しあわ（せ）
3年生港港コウみなと
3年生号号ゴウ-
3年生根コンね
3年生祭サイまつ（る）,まつ（り）
3年生皿皿-さら
3年生仕仕シ,ジつか（える）
3年生死死シし（ぬ）
3年生使使シつか（う）
3年生始始シはじ（める）,はじ（まる）
3年生指指シゆび,さ（す）
3年生歯歯シは
3年生詩詩シ-
3年生次次ジつ（ぐ）,つぎ
3年生事ジ,ズこと
3年生持持ジも（つ）
3年生式式シキ-
3年生実実ジツ,シツみ,みの（る）
3年生写写写うつ（ス）,うつ（る）
3年生者者シャもの
3年生主主シュぬし, oも
3年生守守シュ,スまも（る）,もり
3年生取取シュと（る）
3年生酒酒酒さけ,さか
3年生受受ジュう（ける）,う（かる）
3年生州州シュウ,ス-
3年生拾拾シュウ,ジュウひろ（う）
3年生終終 o（わる）, o（える）
3年生習習なら（う）
3年生集集あつ（まる）,あつ（める）,つど（う）
3年生住住す（む）,す（まう）
3年生重重ジュウ,チョウ oも（い）,かさ（なる）,かさ（ねる）
3年生宿宿シュクやど,やど（る）,やど（す）
3年生所ショところ
3年生暑暑しょあつ（い）
3年生助助ジョたす（ける）,たす（かる）,すけ
3年生昭昭昭-
3年生消消消き（える）,け（ス）
3年生商商商あきな（う）
3年生章章章-
3年生勝勝勝か（つ）,まさ（る）
3年生乗乗乗の（る）,の（せる）
3年生植植植う（える）,う（わる）
3年生申申申もう（ス）
3年生身身身み
3年生神神神,ジンかみ,かん,こう
3年生真真真ま
3年生深深深深ふか（イ）,ふか（まる）,ふか（める）
3年生進進進すす（む）,すす（める）
3年生世世世,セよ
3年生整整整ととの（える）,ととの（う）
3年生昔昔昔むかし
3年生全全全まった（く）,すべ（て）
3年生相相相あい
3年生送送送 oく（る）
3年生想想想-
3年生息息息いき
3年生速速速はや（い）,はや（める）,はや（まる）
3年生族族族-
3年生他他他ほか
3年生打打打う（つ）
3年生対対対-
3年生待待待ま（つ）
3年生代代代か（わる）,か（える）,よ,しろ
3年生第第第-
3年生題題題-
3年生炭炭炭すみ
3年生短短短みじか（い）
3年生談談談-
3年生着着着き（る）,き（せる）,つ（く）,つ（ける）
3年生注注注そそ（ぐ）
3年生柱柱柱はしら
3年生丁丁丁,テイ-
3年生帳帳帳-
3年生調調調しら（べる）,ととの（う）,ととの（える）
3年生追追追 o（う）
3年生定定定,ジョウさだ（める）,さだ（まる）
3年生庭庭庭にわ
3年生笛笛笛テキふえ
3年生鉄鉄鉄テツ-
3年生転転転ころ（がる）,ころ（げる）,ころ（がス）,ころ（ぶ）
3年生都都都ト,ツみやこ
3年生度度度ド,トたび,はか（る）
3年生投投投トウな（げる）
3年生豆豆豆トウ,ズまめ
3年生島島島トウしま
3年生湯湯湯トウゆ
3年生登登登トウ,トのぼ（る）
3年生等等等トウひと（しい）,など
3年生動動動ドウうご（く）,うご（かす）
3年生童童童ドウわらべ
3年生農農農ノウ-
3年生波波波ハなみ
3年生配配配ハイくば（る）
3年生倍倍倍バイ-
3年生箱箱-はこ
3年生畑畑-はた,はたけ
3年生発発発ハツ,ホツ-
3年生反反反ハンそ（る）,そ（らす）,かえ（す）
3年生坂坂坂ハンさか
3年生板板板ハン,バンいた
3年生皮皮皮ヒかわ
3年生悲悲悲ヒかな（しい）,かな（しむ）
3年生美美美ビうつく（しい）
3年生鼻鼻鼻ビはな
3年生筆筆筆ヒツふで
3年生氷氷氷ヒョウこおり,ひ
3年生表表表ヒョウ oもて,あらわ（ス）,あらわ（れる）
3年生秒秒秒ビョウ-
3年生病病病ビョウや（む）,やまい
3年生品品品ヒンしな
3年生負負負フま（ける）,ま（かす）, o（う）
3年生部部部ブ-
3年生服服服フク-
3年生福福フク-
3年生生物物物ブツ,モツもの
3年生平平平ヘイたい（ら）,ひら
3年生返返返ヘンかえ（ス）,かえ（る）
3年生勉勉勉ベンつと（める）
3年生放放放はな（す）,はな（つ）,はな（れる）,ほう（る）
3年生味味味ミあじ,あじ（わう）
3年生命命命メイいのち
3年生面面面メン oも, oもて,つら
3年生問問問モンと（う）,と（い）
3年生役役役ヤク,エキ-
3年生薬薬薬ヤクくすり
3年生由由由ユ,ユウ,ユイよし
3年生油油油ユあぶら
3年生有有有ユウあ（る）
3年生遊遊遊ユウあそ（ぶ）
3年生予予予ヨ-
3年生羊羊羊ヨウひつじ
3年生洋洋洋ヨウ-
3年生葉葉葉ヨウは
3年生陽陽陽ヨウ-
3年生様様様ヨウさま
3年生落落落ラク o（ちる）, o（とす）
3年生流流流リュウ,ルなが（れる）,なが（ス）
3年生旅リョたび
3年生両両リョウ-
3年生緑みどり、ろく
3年生礼礼礼レイ,ライ-
3年生列列列レツ-
3年生練ね（る）
3年生路路路ロじ
3年生和和和ワやわ（らぐ）,やわ（らげる）,なご（む）,なご（やか）
3年生(追加)一イツ-
3年生(追加)二ジ-
3年生(追加)三み
3年生(追加)四よん
3年生(追加)六むい
3年生(追加)八よう
3年生(追加)九九ク-
3年生(追加)十ジッ-
3年生(追加)日ジツ-
3年生(追加)月ガツ-
3年生(追加)金コン-
3年生(追加)本もと
3年生(追加)上のぼ（る）、のぼ（せる）、のぼ（す）
3年生(追加)下ゲくだ（る）、くだ（す）、くだ（さる）、o（ろす）、o（りる）
3年生(追加)円まる（い）
3年生(追加)会会エ-
3年生(追加)合合ガッ-
3年生(追加)交まじ（る）、まざ（る）、まぜ（る）、か（う）、かわ（ス）
3年生(追加)分フン,ブわ（かつ）
4年生愛アイ-
4年生案アン-
4年生以イ-
4年生衣ころも
4年生位くらい
4年生茨いばら
4年生印しるし
4年生英エイ-
4年生栄さか（える）、は（える）
4年生媛エン-
4年生塩しお
4年生岡おか
4年生億オク-
4年生加くわ（える）、くわ（わる）
4年生果は（たす）、は（てる）、はて
4年生貨カ-
4年生課カ-
4年生芽め
4年生賀ガ-
4年生改あらた（める）、あらた（まる）
4年生械カイ-
4年生害ガイ-
4年生街まち
4年生各おのおの
4年生覚おぼ（える）、さ（ます）、さ（める）
4年生潟かた
4年生完カン-
4年生官カン-
4年生管くだ
4年生関せき、かか（わる）
4年生観観カン-
4年生願願ガンねが（う）
4年生岐岐キ-
4年生希希キ-
4年生季季キ-
4年生旗旗キはた
4年生器器キうつわ
4年生機機キはた
4年生議議ギ-
4年生求求キュウもと（める）
4年生泣泣キュウな（く）
4年生給給キュウ-
4年生挙挙キョあ（げる）,あ（がる）
4年生漁漁ギョ,リョウ-
4年生共共キョウとも
4年生協協キョウ-
4年生鏡鏡キョウかがみ
4年生競競キョウ,ケイきそ（う）,せ（る）
4年生極極キョク,ゴクきわ（める）,きわ（まる）,きわ（み）
4年生熊-くま
4年生訓訓クン-
4年生軍軍グン-
4年生郡郡グン-
4年生群群グンむ（れる）,むラ（がる）,むら
4年生径径ケイ-
4年生景景ケイ-
4年生芸芸ゲイ-
4年生欠欠ケツか（ける）,か（く）
4年生結結ケツむす（ぶ）,ゆ（う）
4年生建建ケンた（てる）,た（つ）
4年生健健ケンすこ（やか）
4年生験験ケン-
4年生固固コかた（める）,かた（まる）,かた（い）
4年生功功コウ-
4年生好好コウこの（む）,す（く）
4年生香香コウか,かo（り）,かo（る）
4年生候候コウそうろう
4年生康康コウ-
4年生佐佐サ-
4年生差差サさ（す）
4年生菜菜サイな
4年生最最サイもっと（も）
4年生埼-さい
4年生材材ザイ-
4年生崎-さき
4年生昨昨サク-
4年生札札サツふだ
4年生刷刷サツす（る）
4年生察察サツ-
4年生参参サンまい（る）
4年生産産サンう（む）,う（まれる）,うぶ
4年生散散サンち（る）,ち（らす）,ち（らかす）,ち（らかる）
4年生残残ザンのこ（る）,のこ（す）
4年生氏氏シうじ
4年生司司シ-
4年生試試シこころ（みる）,ため（ス）
4年生児児ジ-
4年生治治ジ,チ oさ（める）, oさ（まる）,なお（る）,なお（す）
4年生滋滋ジ-
4年生辞辞ジや（める）
4年生鹿しか、か
4年生失失シツうしな（う）
4年生借借シャクか（りる）
4年生種種シュたね
4年生周周シュウまわ（り）
4年生祝祝シュクいわ（う）
4年生順ジュン-
4年生初初ショはじ（め）,はじ（めて）,はつ,うい
4年生松松ショウまつ
4年生笑笑ショウわら（う）,え（む）
4年生唱唱ショウとな（える）
4年生焼焼ショウや（く）,や（ける）
4年生照照ショウて（る）,て（らす）,て（れる）
4年生城城ジョウしろ
4年生縄縄ジョウなわ
4年生臣臣シン,ジン-
4年生信信シン-
4年生井-い
4年生成成セイ,ジョウな（る）,な（す）
4年生省省セイ,ショウかえり（みる）,はぶ（く）
4年生清清セイ,ショウきよ（い）,きよ（まる）,きよ（める）
4年生静静セイ,ジョウしず,しず（か）,しず（まる）,しず（める）
4年生席席セキ-
4年生積積セキつ（む）,つ（もる）
4年生折折セツ o（る）,おり, o（れる）
4年生節節セツ,セチふし
4年生説説セツ,ゼイと（く）
4年生浅浅センあさ（い）
4年生戦戦センいくさ,たたか（う）
4年生選選 eら（ぶ）
4年生然然ゼン,ネン-
4年生争争ソウあらそ（う）
4年生倉倉ソウくら
4年生巣巣ソウす
4年生束束ソクたば
4年生側側ソクかわ
4年生続続ゾクつづ（く）,つづ（ける）
4年生卒卒ソツ-
4年生孫孫ソンまご
4年生帯帯タイ o比,おび（る）
4年生隊隊タイ-
4年生達達タツ-
4年生単単タン-
4年生置置チ o（く）
4年生仲仲チュウなか
4年生沖- oき
4年生兆兆チョウきざ（す）,きざ（し）
4年生低低テイひく（い）,ひく（める）,ひく（まる）
4年生底底テイそこ
4年生的的なテキまと
4年生典テン-
4年生伝伝デンつた（わる）,つた（える）,つた（う）
4年生徒ト-
4年生努努ドつと（める）
4年生灯トウひ
4年生働働ドウはたら（く）
4年生特トク-
4年生徳徳トク-
4年生栃-とち
4年生奈奈ナ-
4年生梨梨-なし
4年生熱熱ネツあつ（い）
4年生念念ネン-
4年生败ハイやぶ（れる）
4年生梅梅バイうめ
4年生博ハク,バク-
4年生阪阪ハン-
4年生飯飯ハンめし
4年生飛飛ヒと（ぶ）,と（ばす）
4年生必必ヒツかなら（ず）
4年生票票ヒョウ-
4年生標標ヒョウ-
4年生不不フ,ブ-
4年生夫夫フ,フウおっと
4年生付付フつ（ける）,つ（く）
4年生府府フ-
4年生阜阜フ-
4年生富富フ,フウと（む）,とみ
4年生副副フク-
4年生兵兵ヘイ,ヒョウ-
4年生別別ベツわか（れ、）
4年生辺辺ヘンあた（り）,べ
4年生変変ヘンか（わる）,か（える）
4年生便便ベン,ビンたよ（り）
4年生包包ホウつつ（む）
4年生法法ホウ,ハッ,ホッ-
4年生望望ボウ,モウのぞ（む）
4年生牧牧ボクまき
4年生末末マツ,バツすえ
4年生満満マンみ（ちる）,み（たす）
4年生未未ミ-
4年生民民ミンたみ
4年生无无ム,ブな（い）
4年生約約ヤク-
4年生勇勇ユウいさ（む）
4年生要要ヨウかなめ,い（る）
4年生養養ヨウやしな（う）
4年生浴浴ヨクあ（びる）,あ（びせる）
4年生利利リき（く）
4年生陸陸リク-
4年生良リョウよ（い）
4年生料リョウ-
4年生量リョウはか（る）
4年生輪輪リンわ
4年生類類ルイ-
4年生令令レイ-
4年生冷冷レイつめ（たい）,ひ（える）,ひ（や）,ひ（やす）,ひ（やかす）,さ（める）,さ（ます）
4年生例たと（える）
4年生連連レンつら（なる）,つら（ねる）,つ（れる）
4年生老老ロウ o（いる）
4年生労労ロウ-
4年生録録ロク-
4年生(追加)生ショウ-
4年生(追加)女ニョ-
4年生(追加)画カ-
4年生(追加)作サ-
4年生(追加)食ジキ-
4年生(追加)通とお（す）
4年生(追加)化ケ-
4年生(追加)去コ-
4年生(追加)相ショウ-
4年生(追加)物モツ-
4年生(追加)役エキ-
5年生圧アツ-
5年生囲囲イかこ（む）,かこ（う）
5年生移移イうつ（る）,うつ（す）
5年生因因インよ（る）
5年生永永エイなが（い）
5年生営営エイいとな（む）
5年生衛衛エイ-
5年生易易エキ,イやさ（しい）
5年生益益エキ,ヤク-
5年生液液エキ-
5年生演エン-
5年生応応オウこた（える）
5年生往往オウ-
5年生桜桜オウさくら
5年生可可カ-
5年生仮仮カ,ケかり
5年生価価カあたい
5年生河河カかわ
5年生過過カす（ぎる）,す（ごす）,あやま（つ）,あやま（ち）
5年生快快カイこころよ（い）
5年生解解カイ,ゲと（く）,と（かす）,と（ける）
5年生格格カク,コウ-
5年生確確カクたし（か）,たし（かめる）
5年生額額ガクひたい
5年生刊刊カン-
5年生幹幹カンみき
5年生慣慣カンな（れる）,な（らす）
5年生眼眼ガン,ゲンまなコ
5年生紀紀キ-
5年生基基キもと,もとい
5年生寄寄キよ（る）,よ（せる）
5年生規規キ-
5年生喜喜キよろこ（ぶ）
5年生技技ギわざ
5年生義義ギ-
5年生逆逆ギャクさか,さか（らう）
5年生久久キュウ,クひさ（しい）
5年生旧旧キュウ-
5年生救救キュウすく（う）
5年生居居キョい（る）
5年生許許キョゆる（す）
5年生境境キョウ,ケイさかい
5年生均均キン-
5年生禁禁キン-
5年生句句ク-
5年生型型ケイかた
5年生経経ケイ,キョウへ（る）
5年生洁洁ケツいさぎよ（い）
5年生件件ケン-
5年生険険ケンけわ（しい）
5年生検検ケン-
5年生限限ゲンかぎ（る）
5年生現現ゲンあらわ（れる）,あらわ（す）
5年生減減ゲンへ（る）,へ（らす）
5年生故故コゆえ
5年生個個コ-
5年生護護ゴ-
5年生効効コウき（く）
5年生厚厚コウあつ（い）
5年生耕耕たがや（す）
5年生航航コウ-
5年生鉱鉱コウ-
5年生構構コウかま（える）,かま（う）
5年生興興 o（こる）, o（こす）
5年生講講コウ-
5年生告告コクつ（げる）
5年生混混コンま（じる）,ま（ざる）,ま（ぜる）
5年生査サ-
5年生再再サイ,サふたた（び）
5年生災災サイわざわ（い）
5年生妻妻サイつま
5年生採採サイと（る）
5年生際際サイきわ
5年生在在ザイあ（る）
5年生財財ザイ,サイ-
5年生罪罪ザイつみ
5年生殺殺サツ,サイ,セツころ（ス）
5年生雑雑ザツ,ゾウ-
5年生酸酸サン-
5年生賛賛サン-
5年生士士シ-
5年生支支シささ（える）
5年生史史シ-
5年生志志こころざ（す）,こころざし
5年生枝枝シえだ
5年生师师シ-
5年生資資シ-
5年生飼飼シか（う）
5年生示示ジ,シしめ（す）
5年生似似ジに（る）
5年生識識シキ-
5年生質質シツ,シチ,チ-
5年生舎舎シャ-
5年生謝謝シャあやま（る）
5年生授授ジュさず（ける）,さず（かる）
5年生修修シュウ,シュ oさ（める）, oさ（まる）
5年生述述ジュツの（べる）
5年生術術ジュツ-
5年生準準ジュン-
5年生序序ジョ-
5年生招招ショウまね（く）
5年生証証ショウ-
5年生象象ショウ,ゾウ-
5年生賞賞ショウ-
5年生条条ジョウ-
5年生状状ジョウ-
5年生常常ジョウつね,とこ
5年生情情ジョウ,セイなさ（け）
5年生織織ショク,シキ o（る）
5年生職職ショク-
5年生制制セイ-
5年生性性セイ,ショウ-
5年生政政セイ,ショウまつりごと
5年生勢勢セイいき o（い）
5年生精精セイ,ショウ-
5年生製製セイ-
5年生税税ゼイ-
5年生责责セキせ（める）
5年生績セキ-
5年生接接セツつ（ぐ）
5年生設設セツもう（ける）
5年生絶絶ゼツた（える）,た（やす）,た（つ）
5年生祖ソ-
5年生素素ソ,ス-
5年生総総ソウ-
5年生造造ゾウつく（る）
5年生像像ゾウ-
5年生増増ゾウま（す）,ふ（える）,ふ（やす）
5年生則則ソク-
5年生測測ソクはか（る）
5年生属属ゾク-
5年生率率ソツ,リツひき（いる）
5年生損損ソンそこ（なう）,そこ（ねる）
5年生貸貸タイか（ス）
5年生態態タイ-
5年生団団ダン,トン-
5年生断断ダンた（つ）,ことわ（る）
5年生築築チクきず（く）
5年生貯貯チョ-
5年生張張チョウは（る）
5年生停停停テイ-
5年生提提テイ-
5年生程程テイほど
5年生適適テキ-
5年生統統トウす（べる）
5年生堂ドウ-
5年生銅銅ドウ-
5年生導導ドウみちび（く）
5年生得得トクえ（る）
5年生毒毒-
5年生独独ひとり
5年生任ニンまか（せる）,まか（ス）
5年生燃燃ネンも（える）,も（やす）,も（す）
5年生能能ノウ-
5年生破破ハやぶ（る）,やぶ（れる）
5年生犯ハン o（かす）
5年生判判ハン,バン-
5年生版判ハン-
5年生比比ヒくら（べる）
5年生肥肥ヒこ（える）,こ（やす）,こ（やし）
5年生非非ヒ-
5年生費費ヒつい（やす）
5年生備備ビそな（える）,そな（わる）
5年生評評ヒョウ-
5年生貧貧ヒン,ビンまず（しい）
5年生布布フぬの
5年生婦婦フ-
5年生武武ブ,ム-
5年生復復フク-
5年生複複フク-
5年生仏仏ブツほとけ
5年生粉粉フンこな,こ
5年生編編ヘンあ（む）
5年生弁弁ベン-
5年生保保ホたも（つ）
5年生墓墓ボはか
5年生報報ホウむく（いる）
5年生豊豊ホウゆた（か）
5年生防防ボウふせ（ぐ）
5年生貿貿ボウ-
5年生暴暴ボウ,バクあば（れる）,あば（く）
5年生脈脈ミャク-
5年生務務ムつと（める）,つと（まる）
5年生夢夢ムゆめ
5年生迷迷メイまよ（う）
5年生綿綿わた
5年生輸輸ユ-
5年生余余ヨあま（る）,あま（ス）
5年生容容ヨウ-
5年生略略リャク-
5年生留留リュウ,ルと（める）,と（まる）
5年生領領リョウ-
5年生歴歴レキ-
5年生(追加)絵カイ-
5年生(追加)客カク-
5年生(追加)礼ライ-
5年生(追加)期ゴ-
5年生(追加)治治チ-
5年生(追加)色色シキ-
5年生(追加)省省セイ-
5年生(追加)競競ケイ-
5年生(追加)説説ゼイ-
5年生(追加)夫夫フウ-
5年生(追加)便便ビン-
6年生胃胃イ-
6年生異異イこと,こと（なる）
6年生遺遺イ-
6年生域域イキ-
6年生宇宇ウ-
6年生映映エイうつ（る）,うつ（す）,は（える）
6年生延延エンの（びる）,の（べる）,の（ばす）
6年生沿沿エンそ（う）
6年生恩恩オン-
6年生我我ガわれ,わ
6年生灰灰カイはい
6年生拡拡カク-
6年生革革カクかわ
6年生閣閣カク-
6年生割割カツわ（る）,わり,わ（れる）
6年生株株-かぶ
6年生干干カンほ（す）,ひ（る）
6年生巻巻カンま（く）,ま（き）
6年生看看カン-
6年生開開カン-
6年生危危キあぶ（ない）,あや（うい）,あや（ぶむ）
6年生机机キつくえ
6年生揮揮キ-
6年生貴貴キたっと（い）,とうと（い）,たっと（ぶ）,とうと（ぶ）
6年生疑疑ギうたが（う）
6年生吸吸キュウす（う）
6年生供供キョウ,クそな（える）,とも
6年生胸胸キョウむね,むな
6年生郷郷キョウ,ゴウ-
6年生勤勤キン,ゴンつと（める）,つと（まる）
6年生筋筋キンすじ
6年生系系ケイ-
6年生敬敬ケイうやま（う）
6年生警警ケイ-
6年生劇劇ゲキ-
6年生激激ゲキはげ（しい）
6年生穴穴ケツあな
6年生券券ケン-
6年生絹絹ケンきぬ
6年生権権ケン,ゴン-
6年生憲憲ケン-
6年生源源ゲンみなもと
6年生厳厳ゲン,ゴン oごそ（か）,きび（しい）
6年生己己コ,キ oのれ
6年生呼呼コよ（ぶ）
6年生誤誤ゴあやま（る）
6年生后后コウ-
6年生孝孝コウ-
6年生皇皇コウ,オウ-
6年生紅コウ,クべに,くれない
6年生降降コウ o（りる）, o（ろす）,ふ（る）
6年生鋼鋼コウはがね
6年生刻刻コクきざ（む）
6年生穀穀コク-
6年生骨骨コツほね
6年生困困コンこま（る）
6年生砂砂サ,シャすな
6年生座座すわ（る）
6年生済済サイす（む）,す（ます）
6年生裁裁サイた（つ）,さば（く）
6年生策策サク-
6年生冊冊サツ,サク-
6年生蚕蚕サンかいこ
6年生至至シいた（る）
6年生私私シわたくし,わたし
6年生姿姿シすがた
6年生視視シ-
6年生詞詞シ-
6年生誌誌シ-
6年生磁磁ジ-
6年生射射シャい（る）
6年生捨捨シャす（てる）
6年生尺尺シャク-
6年生若ジャク,ニャクわか（い）,も（しくは）
6年生樹樹ジュ-
6年生収収シュウ o（さめる）, o（さまる）
6年生宗宗シュウ,ソウ-
6年生就就シュウ,ジュつ（く）,つ（ける）
6年生衆衆シュウ,シュ-
6年生従従ジュウ,ショウ,ジュしたが（う）,したが（える）
6年生縦縦ジュウたて
6年生縮縮シュクちぢ（む）,ちぢ（まる）,ちぢ（める）,ちぢ（れる）,ちぢ（らす）
6年生熟熟ジュクう（れ、）
6年生純純ジュン-
6年生処処ショ-
6年生署署ショ-
6年生諸諸ショ-
6年生除除ジョ,ジのぞ（く）
6年生承承ショウうけたまわ（る）
6年生将将ショウ-
6年生傷傷ショウきず,いた（む）,いた（める）
6年生障障ショウさわ（る）
6年生蒸蒸ジョウむ（す）,む（れる）,む（らす）
6年生針針シンはり
6年生仁ジン,ニ-
6年生垂垂スイた（れる）,た（らす）
6年生推推スイ o（す）
6年生寸寸スン-
6年生盛盛セイ,ジョウも（る）,さか（る）,さか（ん）
6年生圣圣セイ-
6年生誠誠セイまこと
6年生舌舌ゼツした
6年生宣宣セン-
6年生専専センもっぱ（ら）
6年生泉泉センいずみ
6年生洗洗センあら（う）
6年生染染センそ（める）,そ（まる）,し（みる）,し（み）
6年生銭銭センぜに
6年生善善ゼンよ（い）
6年生奏奏ソウかな（でる）
6年生窓窓ソウまど
6年生創創ソウつく（る）
6年生装装ソウ,ショウよそお（う）
6年生層ソウ-
6年生操操ソウみさお,あやつ（る）
6年生蔵蔵ゾウくら
6年生臓臓ゾウ-
6年生存存ソン,ゾン-
6年生尊尊ソンたっと（い）,とうと（い）,たっと（ぶ）,とうと（ぶ）
6年生退退タイしりぞ（く）,しりぞ（ける）
6年生宅宅-
6年生担担タンにな（う）
6年生探探タンさが（す）,さぐ（る）
6年生誕誕タン-
6年生段段-
6年生暖暖ダンあたた（か）,あたた（かい）,あたた（まる）,あたた（める）
6年生値ね、あたい
6年生宙宙チュウ-
6年生忠忠チュウ-
6年生著著チョあらわ（す）,いちじる（しい）
6年生庁庁チュウ-
6年生頂頂チョウいただき
6年生腸腸チョウわた
6年生潮潮チョウしお
6年生賃賃チン-
6年生痛痛ツウいた（い）,いた（む）,いた（める）
6年生敵敵かたき
6年生展展テン-
6年生討討トウう（つ）
6年生党党トウ-
6年生糖糖トウ-
6年生届届-とど（ける）,とど（く）
6年生難難ナンかた（い）,むずか（しい）
6年生乳乳ニュウちち,ち
6年生認認ニンみと（める）
6年生納納ノウ,ナッ,ナ,ナン,トウ o（さめる）, o（さまる）
6年生脳脳ノウ-
6年生派派ハ-
6年生拝拝ハイ oが（む）
6年生背背ハイせ,せい,そむ（く）,そむ（ける）
6年生肺肺ハイ-
6年生俳俳ハイ-
6年生班班ハン-
6年生晩晩-
6年生否否ヒいな
6年生批批ヒ-
6年生秘秘ヒひそ（か）
6年生俵俵ヒョウたわら
6年生腹腹フクはら
6年生奮奮フンふる（う）
6年生並並ヘイなみ,なら（べる）,なら（ぶ）,なら（びに）
6年生陛陛ヘイ-
6年生閉閉ヘイと（じる）,と（ざす）,し（める）,し（まる）
6年生片片ヘンかた
6年生補補ホ oぎな（う）
6年生暮暮ボく（れる）,く（らす）
6年生宝宝宝ホウたカラ
6年生訪訪ホウ oとず（れる）,たず（ねる）
6年生亡亡ボウ,モウな（い）
6年生忘忘ボウわす（れる）
6年生棒棒ボウ-
6年生枚枚マイ-
6年生幕幕マク,バク-
6年生密密ミツ-
6年生盟盟メイ-
6年生模模モ,ボ-
6年生訳訳ヤクわけ
6年生郵郵ユウ-
6年生優優ユウやさ（しい）,すぐ（れる）
6年生預預ヨあず（ける）,あず（かる）
6年生幼幼ヨウ oさな（い）
6年生欲欲ヨクほっ（する）,ほ（しい）
6年生翌翌ヨク-
6年生乱乱ランみだ（れる）,みだ（す）
6年生卵卵ランたまご
6年生覧覧ラン-
6年生裏裏リうら
6年生律律リツ,イチ-
6年生臨臨リンのぞ（む）
6年生朗朗ロウほが（らか）
6年生論論ロン-
6年生(追加)後- oく（れる）
6年生(追加)図ト-
6年生(追加)家ケ-
6年生(追加)黄オウ-
6年生(追加)重重チョウ-
6年生(追加)相相ショウ-
6年生(追加)表-あらわ（す）,あらわ（れる）
6年生(追加)期期ゴ-
6年生(追加)無無ブ-
6年生(追加)治治チ-
6年生(追加)易易イ-
6年生(追加)興興キョウ-
6年生(追加)率率SOTSU-
`.trim();

    let kanjiList = [];
    let kanjiStore = {}; 
    let appState = { 
      currentKanji: null, 
      mastered: [], 
      currentStroke: 0, 
      isPracticing: false, 
      animeIsRunning: false, 
      selectedGrade: 1,
      hasMistaken: false,
      reviewQueue: []
    };
    const kanjiPathsCache = {};
    let writeCanvas, inkCanvas, guideCanvas, ctxW, ctxInk, ctxGuide, audioCtx;

    let prefetchQueue = [];
    let isPrefetching = false;

    async function startPrefetching() {
      if (isPrefetching) return;
      isPrefetching = true;
      while (prefetchQueue.length > 0) {
        const char = prefetchQueue.shift();
        if (!kanjiPathsCache[char]) {
          await fetchKanjiVG(char);
          await new Promise(r => setTimeout(r, 20)); 
        }
      }
      isPrefetching = false;
    }

    function queuePrefetch(grade) {
      prefetchQueue = [];
      appState.reviewQueue.forEach(q => { if (!kanjiPathsCache[q.char]) prefetchQueue.push(q.char); });
      let pool = kanjiList.filter(k => k.baseGrade === grade && !appState.mastered.includes(k.char));
      pool.sort(() => Math.random() - 0.5);
      pool.forEach(k => { if (!kanjiPathsCache[k.char] && !prefetchQueue.includes(k.char)) { prefetchQueue.push(k.char); } });
      startPrefetching();
    }

    function el(id) { return document.getElementById(id); }
    function setStyle(id, prop, val) { const element = el(id); if (element) element.style[prop] = val; }
    function setDisplay(id, val) { setStyle(id, 'display', val); }

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function playTone(freq, type, duration, vol = 0.1) {
      if(!audioCtx) return;
      try {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + duration);
      } catch(e) {}
    }
    function playPingPong() { initAudio(); playTone(659.25, 'sine', 0.15, 0.1); setTimeout(() => playTone(880.00, 'sine', 0.3, 0.1), 100); }
    function playBuzzer() { initAudio(); playTone(150, 'square', 0.2, 0.05); }
    function playFanfare() { initAudio(); [0, 150, 300, 500].forEach((t, i) => { const f = [523.25, 659.25, 783.99, 1046.50][i]; setTimeout(() => playTone(f, 'sine', 0.4, 0.15), t); }); }

    function burstConfetti() {
      const canvas = el('confettiCanvas'); if (!canvas) return;
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      const particles = Array.from({length: 60}, () => ({
        x: canvas.width / 2, y: canvas.height / 2, r: Math.random() * 8 + 4, dx: Math.random() * 10 - 5, dy: Math.random() * -10 - 5,
        color: ['#fce7f3', '#fef08a', '#bae6fd', '#a7f3d0', '#c7d2fe'][Math.floor(Math.random() * 5)],
        tiltAngleIncrement: (Math.random() * 0.07) + 0.05, tiltAngle: 0
      }));
      function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); let active = 0;
        particles.forEach(p => {
          p.tiltAngle += p.tiltAngleIncrement; p.y += (Math.cos(p.tiltAngle) + 1 + p.r / 2) / 2; p.x += Math.sin(p.tiltAngle) * 2 + p.dx;
          p.dy += 0.1; p.y += p.dy; if (p.y <= canvas.height) active++;
          ctx.beginPath(); ctx.lineWidth = p.r; ctx.strokeStyle = p.color; ctx.moveTo(p.x + p.r, p.y); ctx.lineTo(p.x, p.y + p.r); ctx.stroke();
        });
        if (active > 0) requestAnimationFrame(render);
      }
      render();
    }

    function getCircleNum(num) {
      if (num >= 7 && num < 99) return "㊥";
      const circles = ["", "①", "②", "③", "④", "⑤", "⑥"];
      return circles[num] || "";
    }

    function parseKanjiData() {
      kanjiStore = {}; 
      const lines = KANJI_DATA_RAW.split('\n');
      lines.forEach(line => {
        line = line.trim(); if(!line) return;
        const match = line.match(/^(\d)年生(?:\(追加\))?\s*(\S)(.*)$/); 
        if(!match) return;
        const grade = parseInt(match[1], 10); 
        const char = match[2]; 
        const readings = match[3];

        if (!kanjiStore[char]) { kanjiStore[char] = { baseGrade: grade, on: [], kun: [] }; }

        const onMatch = readings.match(/^[ア-ンヴー、,]+/);
        let onPart = onMatch ? onMatch[0] : "";
        let kunPart = readings.substring(onPart.length);

        const splitReadings = (str) => str.replace(/^[ー\-\s,、]+/, "").split(/[、,]/).filter(s => s.trim() !== "");

        splitReadings(onPart).forEach(v => {
          const existing = kanjiStore[char].on.find(o => o.v === v);
          if (existing) { if (grade > existing.g) existing.g = grade; } else { kanjiStore[char].on.push({ v, g: grade }); }
        });
        splitReadings(kunPart).forEach(v => {
          const existing = kanjiStore[char].kun.find(o => o.v === v);
          if (existing) { if (grade > existing.g) existing.g = grade; } else { kanjiStore[char].kun.push({ v, g: grade }); }
        });
      });
      kanjiList = Object.entries(kanjiStore).map(([char, data]) => ({ char, ...data }));
    }

    async function fetchKanjiVG(char) {
      if (kanjiPathsCache[char]) return kanjiPathsCache[char];
      const hex = char.charCodeAt(0).toString(16).padStart(5, '0');
      const url = `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`;
      try {
        const res = await fetch(url); if (!res.ok) throw new Error('Network error');
        const text = await res.text(); const doc = new DOMParser().parseFromString(text, 'image/svg+xml');
        const paths = Array.from(doc.querySelectorAll('path')).map(p => p.getAttribute('d')).filter(Boolean);
        kanjiPathsCache[char] = paths; return paths;
      } catch (e) { return null; }
    }

    function init() {
      writeCanvas = el('writeCanvas'); inkCanvas = el('inkCanvas'); guideCanvas = el('guideCanvas');
      if (!writeCanvas) return;
      ctxW = writeCanvas.getContext('2d'); ctxInk = inkCanvas.getContext('2d'); ctxGuide = guideCanvas.getContext('2d');
      if (kanjiList.length === 0) parseKanjiData();
      const saved = localStorage.getItem('kanji_app_mastered_list'); if (saved) { try { appState.mastered = JSON.parse(saved); } catch(e){} }
      const savedGrade = localStorage.getItem('kanji_app_grade'); if (savedGrade) { appState.selectedGrade = parseInt(savedGrade, 10); }
      setupEvents(); selectRandomKanji(); window.addEventListener('resize', resizeCanvas);
      updateSliderBg(); queuePrefetch(appState.selectedGrade);
    }

    function updateSliderBg() {
      const slider = el('speedSlider'); if (!slider) return;
      const val = (slider.value - slider.min) / (slider.max - slider.min) * 100;
      slider.style.background = `linear-gradient(to right, #38bdf8 0%, #38bdf8 ${val}%, #e2e8f0 ${val}%, #e2e8f0 100%)`;
    }

    async function selectSpecificKanji(char) {
      if (!char) return;
      let selected = kanjiList.find(k => k.char === char);
      if (!selected) {
        selected = { char: char, baseGrade: 99, on: [], kun: [{ v: "？？", g: 99 }] };
        if(!kanjiStore[char]) kanjiStore[char] = selected;
      }
      appState.selectedGrade = selected.baseGrade;
      localStorage.setItem('kanji_app_grade', appState.selectedGrade);
      appState.currentKanji = selected; appState.currentStroke = 0; appState.hasMistaken = false;
      if (ctxW) ctxW.clearRect(0, 0, writeCanvas.width, writeCanvas.height);
      if (ctxInk) ctxInk.clearRect(0, 0, inkCanvas.width, inkCanvas.height);
      stopPractice(); closeAnime(); updateGradeButtons();
      const statusEl = el('testStatus'); if (statusEl) statusEl.innerText = "よみこみ中...";
      const paths = await fetchKanjiVG(char);
      if (!paths || paths.length === 0) { if(statusEl) statusEl.innerText = "データが ありません"; return; }
      appState.currentKanji.paths = paths;
      setTimeout(() => { resizeCanvas(); updateUI(); }, 50);
    }

    async function selectRandomKanji() {
      appState.reviewQueue.forEach(q => q.wait--);
      let targetChar = null;
      const reviewTarget = appState.reviewQueue.find(q => q.wait <= 0 && !appState.mastered.includes(q.char));
      if (reviewTarget) { targetChar = reviewTarget.char; appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== targetChar); }
      let selected;
      if (targetChar) { selected = kanjiList.find(k => k.char === targetChar); }
      if (!selected) {
        let pool = kanjiList.filter(k => k.baseGrade === appState.selectedGrade && !appState.mastered.includes(k.char));
        if (appState.currentKanji) pool = pool.filter(k => k.char !== appState.currentKanji.char);
        if (pool.length === 0) pool = kanjiList.filter(k => k.baseGrade === appState.selectedGrade);
        if (pool.length === 0) { if (appState.selectedGrade !== 1) { changeGrade(1); } return; }
        selected = pool[Math.floor(Math.random() * pool.length)];
      }
      selectSpecificKanji(selected.char);
    }

    function changeGrade(g) { appState.selectedGrade = g; localStorage.setItem('kanji_app_grade', g); selectRandomKanji(); queuePrefetch(g); }
    
    function updateGradeButtons() {
      for(let i=1; i<=6; i++) {
        const btn = el('gb' + i); if (!btn) continue;
        if (i === appState.selectedGrade) btn.classList.add('active'); else btn.classList.remove('active');
      }
    }
    
    function resizeCanvas() {
      const grid = el('writeGrid'); if (!grid || !writeCanvas) return;
      const size = grid.clientHeight; if (size === 0) return;
      [writeCanvas, inkCanvas, guideCanvas].forEach(c => { c.width = size; c.height = size; });
      redrawGuide(); redrawInk();
    }
    
    function redrawGuide() {
      if (!appState.currentKanji || !guideCanvas || !appState.currentKanji.paths) return;
      const size = guideCanvas.width; ctxGuide.clearRect(0, 0, size, size);
      ctxGuide.save(); ctxGuide.scale(size/109, size/109); ctxGuide.strokeStyle = "#e2e8f0"; ctxGuide.lineWidth = 6; ctxGuide.lineCap = 'round'; ctxGuide.lineJoin = 'round';
      appState.currentKanji.paths.forEach(p => { ctxGuide.stroke(new Path2D(p)); });
      ctxGuide.restore();
    }
    
    function renderReadings(containerId, list, baseGrade) {
      const container = el(containerId); if (!container) return;
      container.innerHTML = '';
      if(list.length === 0) { container.innerHTML = '<div class="vertical-text opacity-30">-</div>'; return; }
      list.slice(0, 3).forEach(item => {
        const div = document.createElement('div'); div.className = 'vertical-text';
        const marker = (item.g > baseGrade) ? getCircleNum(item.g) : "　";
        div.innerText = marker + item.v; container.appendChild(div);
      });
    }

    function getPathStartPoint(pathStr) {
      const svg = el('animeSvg'); const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", pathStr); svg.appendChild(path); const start = path.getPointAtLength(0); svg.removeChild(path);
      return { x: start.x, y: start.y };
    }

    function updateUI() {
      const k = appState.currentKanji; if (!k || !k.paths) return;
      const infoSvg = el('infoKanjiSvg');
      if (infoSvg) {
        infoSvg.innerHTML = '';
        k.paths.forEach(p => {
          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", p); path.setAttribute("class", "info-stroke-path"); infoSvg.appendChild(path);
        });
      }
      const gradeLabel = el('currentGradeLabel');
      if (gradeLabel) {
        if (k.baseGrade <= 6) gradeLabel.innerText = k.baseGrade + "ねんせいでならうかん字";
        else gradeLabel.innerText = "とくべつな かん字";
      }
      redrawGuide();
      const stText = el('strokeCountText'); if (stText) stText.textContent = k.paths.length;
      renderReadings('kunReadings', k.kun, k.baseGrade); renderReadings('onReadings', k.on, k.baseGrade);
      renderMasteredList();
      
      const animeBgGroup = el('animeBgGroup'); const strkGrp = el('strokeGroup'); const numGrp = el('numberGroup'); 
      if (!animeBgGroup || !strkGrp || !numGrp) return;
      animeBgGroup.innerHTML = ''; strkGrp.innerHTML = ''; numGrp.innerHTML = ''; 
      const placedPositions = [];
      k.paths.forEach((p, i) => {
        const bgPath = document.createElementNS("http://www.w3.org/2000/svg", "path"); bgPath.setAttribute("d", p); bgPath.setAttribute("class", "bg-stroke-path"); animeBgGroup.appendChild(bgPath);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", p); path.setAttribute("class", "stroke-path"); path.id = `anime-s-${i}`; path.style.strokeDasharray = "1000"; path.style.strokeDashoffset = "1000"; strkGrp.appendChild(path);
        const startPt = getPathStartPoint(p);
        let baseX = Math.max(8, Math.min(101, startPt.x - 12));
        let baseY = Math.max(8, Math.min(101, startPt.y - 12));
        let cx = baseX, cy = baseY;
        const minDistance = 13;
        let collision = true, angle = 0, radius = 0, step = 0;
        while (collision && step < 50) {
          collision = false;
          if (cx < 8 || cx > 101 || cy < 8 || cy > 101) collision = true;
          if (!collision) { for (let j = 0; j < placedPositions.length; j++) { if (Math.hypot(cx - placedPositions[j].x, cy - placedPositions[j].y) < minDistance) { collision = true; break; } } }
          if (collision) { step++; angle += Math.PI / 3; if (step % 6 === 0) radius += 6; cx = baseX + Math.cos(angle) * (6 + radius); cy = baseY + Math.sin(angle) * (6 + radius); }
        }
        cx = Math.max(8, Math.min(101, cx)); cy = Math.max(8, Math.min(101, cy));
        placedPositions.push({x: cx, y: cy});
        const g = document.createElementNS("http://www.w3.org/2000/svg", "g"); g.id = `anime-num-${i}`; g.style.opacity = "0"; g.style.transition = "opacity 0.2s ease-in";
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle"); circle.setAttribute("cx", cx); circle.setAttribute("cy", cy); circle.setAttribute("r", "5.5"); circle.setAttribute("fill", "#ffffff"); circle.setAttribute("stroke", "#f97316"); circle.setAttribute("stroke-width", "1.2");
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text"); text.setAttribute("x", cx); text.setAttribute("y", cy + 0.5); text.setAttribute("dominant-baseline", "central"); text.setAttribute("text-anchor", "middle"); text.setAttribute("font-size", "6"); text.setAttribute("font-weight", "900"); text.setAttribute("fill", "#f97316"); text.style.fontFamily = "sans-serif"; text.textContent = (i + 1).toString();
        g.appendChild(circle); g.appendChild(text); numGrp.appendChild(g);
      });
    }

    function startPractice() {
      initAudio(); appState.isPracticing = true; appState.currentStroke = 0;
      ['kunCard', 'onCard', 'currentGradeLabelContainer', 'practiceControls'].forEach(id => setDisplay(id, 'none'));
      const spBtn = el('startPracticeBtn'); if (spBtn) spBtn.classList.add('hidden');
      const infoLabel = el('infoLabel'); if (infoLabel) infoLabel.style.visibility = 'hidden';
      ctxInk.clearRect(0,0,inkCanvas.width, inkCanvas.height); ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height);
      const wa = el('writeArea'); if (wa) wa.classList.remove('locked');
      const cb = el('clearBtn'); if (cb) cb.classList.remove('locked');
      const statusEl = el('testStatus'); if (statusEl) { statusEl.innerText = "１かくめ をかこう！"; statusEl.className = "text-sm font-black text-white bg-orange-400 px-4 py-1.5 rounded-full shadow-md"; }
      playTone(440, 'sine', 0.1);
    }

    function restartPractice() { if (appState.isPracticing) { appState.hasMistaken = true; startPractice(); } }
    function stopPractice() {
      appState.isPracticing = false; 
      const wa = el('writeArea'); if (wa) wa.classList.add('locked');
      const cb = el('clearBtn'); if (cb) cb.classList.add('locked');
      ['kunCard', 'onCard', 'practiceControls'].forEach(id => setDisplay(id, 'flex'));
      setDisplay('currentGradeLabelContainer', 'block');
      const infoLabel = el('infoLabel'); if (infoLabel) infoLabel.style.visibility = 'visible';
      const statusEl = el('testStatus'); if (statusEl) { statusEl.innerText = "ロック中 🔒"; statusEl.className = "text-sm font-black text-slate-400 bg-slate-100 px-4 py-1.5 rounded-full shadow-inner"; }
      const spBtn = el('startPracticeBtn'); if (spBtn) spBtn.classList.remove('hidden');
      const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.add('hidden');
      const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.remove('hidden');
    }

    function handleMistake(msg) {
      appState.hasMistaken = true; const statusEl = el('testStatus'); if (!statusEl) return;
      statusEl.innerText = msg; statusEl.className = "text-sm font-black text-white bg-rose-400 px-4 py-1.5 rounded-full shadow-md";
      playBuzzer(); setDisplay('practiceControls', 'flex');
      const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.add('hidden');
      const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.remove('hidden');
    }

    async function playAnime() {
      if (appState.animeIsRunning) return;
      initAudio(); appState.animeIsRunning = true; const paths = appState.currentKanji.paths;
      const speed = el('speedSlider').value; const durationMs = (11 - speed) * 150; 
      paths.forEach((_, i) => { const pEl = el(`anime-s-${i}`); if(pEl) { pEl.style.transition = 'none'; pEl.style.strokeDashoffset = "1000"; } const nEl = el(`anime-num-${i}`); if(nEl) { nEl.style.opacity = "0"; } });
      for(let i=0; i<paths.length; i++) {
        const pEl = el(`anime-s-${i}`); if (!pEl) continue;
        const nEl = el(`anime-num-${i}`); if (nEl) nEl.style.opacity = "1";
        await new Promise(r => setTimeout(r, 100));
        pEl.style.transition = `stroke-dashoffset ${durationMs}ms ease-in-out`; pEl.getBoundingClientRect(); pEl.style.strokeDashoffset = "0";
        playTone(500 + (i*50), 'triangle', durationMs/1000, 0.05); await new Promise(r => setTimeout(r, durationMs + 200));
      }
      appState.animeIsRunning = false;
    }

    function getStartEndPoints(pathStr) {
      const svg = el('animeSvg'); const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", pathStr); svg.appendChild(path); const len = path.getTotalLength(); const start = path.getPointAtLength(0); const end = path.getPointAtLength(len);
      svg.removeChild(path); return { s: { x: start.x / 109, y: start.y / 109 }, e: { x: end.x / 109, y: end.y / 109 } };
    }

    let drawing = false; let lastX, lastY; const TOLERANCE = 0.15; 
    function startDraw(e) {
      if (!appState.isPracticing) return;
      const rect = writeCanvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      const strokes = appState.currentKanji.paths; if(appState.currentStroke >= strokes.length) return;
      const target = getStartEndPoints(strokes[appState.currentStroke]).s;
      const dist = Math.hypot(x / writeCanvas.width - target.x, y / writeCanvas.height - target.y);
      if (dist > TOLERANCE) { handleMistake("かきじゅんが ちがいます"); return; }
      drawing = true; lastX = x; lastY = y;
      ctxW.lineCap = 'round'; ctxW.lineJoin = 'round'; ctxW.lineWidth = writeCanvas.width * 0.06; ctxW.strokeStyle = "rgba(14, 165, 233, 0.7)"; ctxW.beginPath(); ctxW.moveTo(x, y); ctxW.stroke();
    }
    
    function draw(e) {
      if (!drawing) return;
      const rect = writeCanvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      ctxW.beginPath(); ctxW.moveTo(lastX, lastY); ctxW.lineTo(x, y); ctxW.stroke(); lastX = x; lastY = y;
    }
    
    function endDraw() {
      if (!drawing) return; drawing = false;
      const strokes = appState.currentKanji.paths; const target = getStartEndPoints(strokes[appState.currentStroke]).e;
      const dist = Math.hypot(lastX / writeCanvas.width - target.x, lastY / writeCanvas.height - target.y);
      if (dist < TOLERANCE) {
        appState.currentStroke++; redrawInk(); ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height);
        if (appState.currentStroke >= strokes.length) {
          setDisplay('practiceControls', 'flex'); const sbBtn = el('submitBtn'); if (sbBtn) sbBtn.classList.remove('hidden'); const saBtn = el('showAnimeBtn'); if (saBtn) saBtn.classList.add('hidden');
          const statusEl = el('testStatus');
          if (!appState.hasMistaken) {
            if (statusEl) { statusEl.innerText = "💮 クリア！"; statusEl.className = "text-sm font-black text-white bg-emerald-500 px-4 py-1.5 rounded-full shadow-lg"; }
            playFanfare(); burstConfetti(); showExcellentPopup();
            if (!appState.mastered.includes(appState.currentKanji.char)) { 
              appState.mastered.push(appState.currentKanji.char); localStorage.setItem('kanji_app_mastered_list', JSON.stringify(appState.mastered)); 
              appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== appState.currentKanji.char);
              setTimeout(() => { hideExcellentPopup(); flyToCollection(appState.currentKanji.char); }, 1500);
            } else { appState.reviewQueue = appState.reviewQueue.filter(q => q.char !== appState.currentKanji.char); setTimeout(() => { hideExcellentPopup(); renderMasteredList(); }, 1500); }
          } else {
            if (statusEl) { statusEl.innerText = "つぎは いっかいで かこう！"; statusEl.className = "text-sm font-black text-white bg-orange-500 px-4 py-1.5 rounded-full shadow-lg"; }
            playPingPong(); const existing = appState.reviewQueue.find(q => q.char === appState.currentKanji.char);
            if (existing) existing.wait = 3; else appState.reviewQueue.push({ char: appState.currentKanji.char, wait: 3 });
          }
        } else { const statusEl = el('testStatus'); if (statusEl) statusEl.innerText = (appState.currentStroke + 1) + "かくめ をかこう！"; playPingPong(); }
      } else { ctxW.clearRect(0,0,writeCanvas.width, writeCanvas.height); handleMistake("さいごまで なぞってね💦"); }
    }

    function redrawInk() {
      const size = inkCanvas.width; ctxInk.clearRect(0,0,size,size); if (appState.currentStroke === 0) return;
      ctxInk.save(); ctxInk.scale(size/109, size/109); ctxInk.strokeStyle = "#000000"; ctxInk.lineWidth = 6; ctxInk.lineCap = 'round'; ctxInk.lineJoin = 'round';
      const strokes = appState.currentKanji.paths; for(let i=0; i<appState.currentStroke; i++) ctxInk.stroke(new Path2D(strokes[i]));
      ctxInk.restore();
    }

    function closeAnime() { const af = el('animeFrame'); if (af) af.classList.add('hidden'); setDisplay('infoFrame', 'flex'); if (appState.isPracticing) restartPractice(); }

    function setupEvents() {
      el('startPracticeBtn').onclick = startPractice; el('closeAnimeBtn').onclick = closeAnime; el('playBtn').onclick = playAnime; el('showAnimeBtn').onclick = () => { setDisplay('infoFrame', 'none'); el('animeFrame').classList.remove('hidden'); }; el('clearBtn').onclick = restartPractice; el('submitBtn').onclick = selectRandomKanji; el('skipToNextBtn').onclick = selectRandomKanji; el('resetAllBtn').onclick = () => { if(confirm("データを けしますか？")) { localStorage.clear(); location.reload(); } };
      const triggerSearch = () => { const val = el('searchInput').value.trim(); if (val) selectSpecificKanji(val); el('searchInput').value = ""; };
      el('searchBtn').onclick = triggerSearch; el('searchInput').onkeypress = (e) => { if (e.key === 'Enter') triggerSearch(); };
      const slider = el('speedSlider'); if (slider) slider.addEventListener('input', updateSliderBg);
      const preventDefault = (e) => { e.preventDefault(); };
      writeCanvas.addEventListener('mousedown', startDraw); writeCanvas.addEventListener('mousemove', draw); writeCanvas.addEventListener('mouseup', endDraw); writeCanvas.addEventListener('mouseleave', endDraw);
      writeCanvas.addEventListener('touchstart', (e) => { preventDefault(e); startDraw(e); }, {passive: false}); writeCanvas.addEventListener('touchmove', (e) => { preventDefault(e); draw(e); }, {passive: false}); writeCanvas.addEventListener('touchend', endDraw, {passive: false});
    }

    function renderMasteredList() {
      const container = el('masteredList'); if (!container) return; container.innerHTML = '';
      const gradeKanjiList = kanjiList.filter(k => k.baseGrade === appState.selectedGrade);
      const totalInGrade = gradeKanjiList.length; const masteredInGradeCount = gradeKanjiList.filter(k => appState.mastered.includes(k.char)).length;
      const progressEl = el('gradeProgress'); if (progressEl) { if (appState.selectedGrade <= 6) progressEl.innerText = `${masteredInGradeCount} ／ ${totalInGrade} 字`; else progressEl.innerText = "とくべつ"; }
      const masteredToShow = appState.mastered.filter(char => { const kData = kanjiStore[char]; if (appState.selectedGrade <= 6) return kData && kData.baseGrade === appState.selectedGrade; return !kData || kData.baseGrade > 6; }).reverse();
      masteredToShow.forEach(c => {
        const d = document.createElement('div'); d.className = 'w-8 h-8 md:w-9 md:h-9 bg-white border-2 border-amber-300 rounded-full flex items-center justify-center kyokasho text-sm md:text-base font-black text-amber-700 shadow-sm shrink-0'; d.innerText = c; container.appendChild(d);
      });
      const countEl = el('masterTotalCount'); if (countEl) countEl.textContent = appState.mastered.length;
    }

    function showExcellentPopup() { const popup = el('excellentPopup'); if (!popup) return; popup.classList.remove('opacity-0', 'scale-50'); popup.classList.add('opacity-100', 'scale-100'); }
    function hideExcellentPopup() { const popup = el('excellentPopup'); if (!popup) return; popup.classList.remove('opacity-100', 'scale-100'); popup.classList.add('opacity-0', 'scale-50'); }

    function flyToCollection(char) {
      const sourceGrid = document.querySelector('.kanji-grid'); if (!sourceGrid) { renderMasteredList(); return; }
      const sourceRect = sourceGrid.getBoundingClientRect(); const targetList = el('masteredList'); if (!targetList) { renderMasteredList(); return; }
      const targetRect = targetList.getBoundingClientRect(); const flier = document.createElement('div');
      flier.className = 'fixed z-[150] kyokasho text-amber-500 bg-white border-4 border-amber-300 rounded-full flex items-center justify-center shadow-xl font-black';
      flier.style.width = sourceRect.width + 'px'; flier.style.height = sourceRect.height + 'px';
      flier.style.left = sourceRect.left + 'px'; flier.style.top = sourceRect.top + 'px';
      flier.style.fontSize = (sourceRect.height * 0.7) + 'px'; flier.style.lineHeight = '1';
      flier.innerText = char; document.body.appendChild(flier);
      const targetCenterX = targetRect.left + 26; const targetCenterY = targetRect.top + 26;
      const sourceCenterX = sourceRect.left + sourceRect.width / 2; const sourceCenterY = sourceRect.top + sourceRect.height / 2;
      const translateX = targetCenterX - sourceCenterX; const translateY = targetCenterY - sourceCenterY;
      const targetScale = 36 / sourceRect.width;
      const anim = flier.animate([ { transform: 'translate(0px, 0px) scale(1) rotate(0deg)', opacity: 1 }, { transform: `translate(${translateX}px, ${translateY}px) scale(${targetScale}) rotate(360deg)`, opacity: 0 } ], { duration: 1200, easing: 'ease-in', fill: 'forwards' });
      anim.onfinish = () => { playTone(880, 'sine', 0.1); setTimeout(() => playTone(1108.73, 'sine', 0.15), 80); flier.remove(); renderMasteredList(); };
    }

    window.onload = () => { init(); setTimeout(() => { setStyle('appBody', 'opacity', '1'); }, 100); };
  </script>
</body>
</html>
